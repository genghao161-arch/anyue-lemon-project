<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®¢æœèŠå¤© Â· çŸ³åˆ»æŠ¤æŸ </title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      /* èŠå¤©åŒºåŸŸï¼šé¡¶éƒ¨æ ‡é¢˜ä¸åº•éƒ¨å‘é€æ¡†å›ºå®šï¼Œä»…ä¸­é—´å†…å®¹æ»šåŠ¨ */
      .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px);
        min-height: 400px;
        max-height: 720px;
        background: #f8f8f8;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      }
      .chat-header {
        flex-shrink: 0;
        background: white;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .chat-header h2 {
        font-size: 18px;
        font-weight: 600;
        color: var(--ink);
        margin: 0;
      }
      .chat-body {
        flex: 1;
        min-height: 0;
        padding: 20px;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      #chatMessageList {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .message-row {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      .message-row--left {
        align-self: flex-start;
        flex-direction: row;
      }
      .message-row--right {
        align-self: flex-end;
        flex-direction: row-reverse;
      }
      .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 14px;
        font-weight: 600;
      }
      .message-avatar--bot {
        background: linear-gradient(135deg, #7f8c8d, #95a5a6);
      }
      .message-avatar--user {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
      }
      .message {
        max-width: 78%;
        padding: 14px 16px;
        border-radius: 14px;
      }
      .message-bot {
        background: white;
        border: 1px solid rgba(0,0,0,0.06);
        border-bottom-left-radius: 4px;
      }
      .message-user {
        background: var(--accent);
        color: white;
        border-bottom-right-radius: 4px;
      }
      .consultation-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 20px;
        margin-bottom: 20px;
        margin-left: auto;
        max-width: 360px;
        border: 1px solid rgba(200, 176, 106, 0.2);
        animation: slideInRight 0.4s ease-out;
      }
      @keyframes slideInRight {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      .consultation-header {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
      }
      .consultation-img {
        width: 72px;
        height: 72px;
        border-radius: 10px;
        object-fit: cover;
        background: #f5f5f5;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      }
      .consultation-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 6px;
      }
      .consultation-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--ink);
        margin: 0;
      }
      .consultation-price {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent);
        margin: 0;
      }
      .send-link-full-btn {
        width: 100%;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s ease;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(200, 176, 106, 0.2);
      }
      .send-link-full-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(200, 176, 106, 0.3);
      }
      .send-link-full-btn:active {
        transform: translateY(0);
      }
      .send-link-full-btn:disabled {
        background: #f0f0f0;
        color: #999;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }
      .consultation-actions {
        display: flex;
        gap: 10px;
        justify-content: space-between;
      }
      .action-chip {
        flex: 1;
        padding: 10px 4px;
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 10px;
        font-size: 12px;
        color: #555;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }
      .action-chip:hover {
        background: white;
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        transform: translateY(-2px);
      }
      .action-chip i {
        font-size: 16px;
        margin-bottom: 2px;
        font-style: normal;
      }
      .chat-footer {
        flex-shrink: 0;
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .input-container {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }
      .input-tools {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .tool-btn {
        width: 36px;
        height: 36px;
        background: #f0f0f0;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
      }
      .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 24px;
        font-size: 14px;
        resize: none;
        min-height: 48px;
        max-height: 120px;
      }
      .chat-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(255, 167, 38, 0.1);
      }
      .send-btn {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .chat-options {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        margin-left: auto;
        max-width: 400px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .option-item {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(160, 140, 90, 0.3);
        border-radius: 20px;
        transition: all 0.3s ease;
      }
      .option-item:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: var(--accent);
        transform: translateY(-2px);
      }
      .option-item input[type="radio"] {
        cursor: pointer;
        accent-color: var(--accent);
      }
      .option-item input[type="radio"]:checked + label {
        color: var(--accent);
        font-weight: 600;
      }
      .option-item label {
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      .option-item--selected {
        background: rgba(200, 176, 106, 0.2);
        border-color: var(--accent);
      }
      
      /* å•†å“è¯¦æƒ…å±•ç¤ºåŒºåŸŸ */
      .product-detail-panel {
        display: none;
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 16px;
        margin-left: auto;
        max-width: 400px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        animation: slideIn 0.3s ease-out;
      }
      .product-detail-panel--show {
        display: block;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .detail-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--ink);
        margin: 0 0 12px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid #e0e0e0;
      }
      .detail-content {
        font-size: 14px;
        line-height: 1.6;
        color: var(--muted);
      }
      .detail-item {
        margin-bottom: 8px;
      }
      .detail-label {
        font-weight: 500;
        color: var(--ink);
        margin-right: 8px;
      }
      
      /* æ¶ˆæ¯ä¸­çš„å•†å“å¡ç‰‡æ ·å¼ */
      .message-product-card {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        margin-top: 8px;
        border: 1px solid rgba(200, 176, 106, 0.2);
      }
      .message-product-image {
        width: 60px;
        height: 60px;
        background: #f0f0f0;
        border-radius: 6px;
        flex-shrink: 0;
        overflow: hidden;
      }
      .message-product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .message-product-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .message-product-title {
        font-size: 13px;
        font-weight: 500;
        color: var(--ink);
        margin: 0;
      }
      .message-product-price {
        font-size: 14px;
        font-weight: 700;
        color: var(--accent);
        margin: 0;
      }
      
      /* è¡¨æƒ…é€‰æ‹©å™¨æ ·å¼ */
      .emoji-picker {
        position: absolute;
        bottom: 70px;
        left: 0;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 16px;
        width: 320px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }
      .emoji-picker--show {
        display: block;
        animation: slideUp 0.3s ease-out;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .emoji-category {
        margin-bottom: 12px;
      }
      .emoji-category-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 8px;
        text-transform: uppercase;
      }
      .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 4px;
      }
      .emoji-item {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .emoji-item:hover {
        background: rgba(200, 176, 106, 0.1);
        transform: scale(1.1);
      }
      
      /* å›¾ç‰‡ä¸Šä¼ ç›¸å…³æ ·å¼ */
      .image-upload-input {
        display: none;
      }
      .message-image {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 8px;
        object-fit: cover;
        cursor: pointer;
      }
      .image-preview-container {
        position: relative;
        display: inline-block;
        margin-top: 8px;
      }
      .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        object-fit: cover;
      }
      .image-remove {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: rgba(244, 67, 54, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .input-container {
        position: relative;
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar__inner">
        <a class="brand" href="index.html" aria-label="è¿”å›å•†å“é¡µ">
          <img class="brand__logo" src="assets/logo.png" alt="çŸ³åˆ»æŠ¤æŸ  Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
          <span class="brand__text" style="display:none;">çŸ³åˆ»æŠ¤æŸ </span>
        </a>

        <nav class="nav">
          <a class="nav__item" href="weather.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M7.5 18.5h10.2a4.3 4.3 0 0 0 .5-8.6A6.2 6.2 0 0 0 6.1 8.4 4.4 4.4 0 0 0 7.5 18.5Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            å¤©æ°”
          </a>
          <a class="nav__item" href="index.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M7.5 8.2V7a4.5 4.5 0 0 1 9 0v1.2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M6.3 8.2h11.4l1 12.5H5.3l1-12.5Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
            </span>
            å•†å“
          </a>
          <a class="nav__item" href="activate.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M6.6 4.8h9.7a2.2 2.2 0 0 1 2.2 2.2v12.2a2.2 2.2 0 0 0-2.2-2.2H6.6a2.2 2.2 0 0 0-2.2 2.2V7a2.2 2.2 0 0 1 2.2-2.2Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M8.2 7.6h7.1M8.2 10.4h7.1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            </span>
            æ´»åŠ¨
          </a>
          <a class="nav__item" href="store.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="9" r="2.5" stroke="currentColor" stroke-width="1.6"/></svg>
            </span>
            é—¨åº—
          </a>
        </nav>

        <div class="topbar__right">
          <a class="toplink" href="favorites.html">æˆ‘çš„æ”¶è—</a>
          <div class="topbar__auth" id="authArea">
            <a class="toplink" href="login.html" id="authLink">ç™»å½•æ³¨å†Œ</a>
          </div>
        </div>
      </div>
      <div class="topbar__divider"></div>
    </header>

    <main class="page">
      <section class="container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <a href="javascript:void(0)" onclick="history.back(); return false;" style="color: var(--accent2); text-decoration: none; cursor: pointer;">&lt; è¿”å›</a>
            <a href="index.html" style="color: var(--accent2); text-decoration: none;">é¦–é¡µ</a>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <a href="favorites.html" style="color: var(--accent2); text-decoration: none;">æ”¶è—</a>
            <a href="vote.html" style="color: var(--accent2); text-decoration: none;">ä¸ªäººä¸­å¿ƒ</a>
          </div>
        </div>

        <div class="chat-container">
          <div class="chat-header">
            <h2>çŸ³åˆ»æŠ¤æŸ å®¢æœ</h2>
            <span style="font-size: 14px; color: #999;">åœ¨çº¿</span>
          </div>
          
          <div class="chat-body">
            <!-- ä»…æ¶ˆæ¯åˆ—è¡¨ï¼šå•†å“é“¾æ¥ä½œä¸ºæ¶ˆæ¯çš„ä¸€éƒ¨åˆ†æ˜¾ç¤ºï¼ˆä¼šè¢«æ–°æ¶ˆæ¯è‡ªç„¶é¡¶ä¸Šå»ï¼‰ -->
            <div id="chatMessageList">
              <div class="message message-bot">
                <p style="margin: 0; font-size: 14px; color: #666;">æ‚¨å¥½ï¼æ¬¢è¿å’¨è¯¢çŸ³åˆ»æŠ¤æŸ ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ</p>
              </div>
            </div>
          </div>
          
          <div class="chat-footer">
            <div class="input-container">
              <div class="input-tools">
                <button class="tool-btn" type="button" title="è¡¨æƒ…" id="emojiBtn">ğŸ˜€</button>
                <button class="tool-btn" type="button" title="å›¾ç‰‡" id="imageBtn">ğŸ–¼ï¸</button>
              </div>
              <textarea class="chat-input" id="chatInput" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦å’¨è¯¢çš„å†…å®¹..."></textarea>
              <input type="file" id="imageUpload" class="image-upload-input" accept="image/*" />
              <button class="send-btn" type="button" id="sendBtn">å‘é€</button>
            </div>
            <!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
            <div class="emoji-picker" id="emojiPicker">
              <div class="emoji-category">
                <div class="emoji-category-title">å¸¸ç”¨è¡¨æƒ…</div>
                <div class="emoji-grid" id="emojiGrid">
                  <!-- è¡¨æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
      const BACKEND = typeof BACKEND_BASE_URL !== 'undefined' ? BACKEND_BASE_URL : '';
      let customerLoggedIn = false;
      let customerMessagePollTimer = null;

      function renderChatMessages(items) {
        const list = document.getElementById('chatMessageList');
        if (!list) return;
        if (!items || items.length === 0) {
          list.innerHTML = '<div class="message-row message-row--left"><span class="message-avatar message-avatar--bot">å®¢</span><div class="message message-bot"><p style="margin: 0; font-size: 14px; color: #666;">æ‚¨å¥½ï¼æ¬¢è¿å’¨è¯¢çŸ³åˆ»æŠ¤æŸ ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ</p></div></div>';
          return;
        }
        list.innerHTML = items.map(function(m) {
          const isUser = m.senderType === 'customer';
          const rowClass = isUser ? 'message-row message-row--right' : 'message-row message-row--left';
          const avatarClass = isUser ? 'message-avatar message-avatar--user' : 'message-avatar message-avatar--bot';
          const avatarLetter = isUser ? 'æˆ‘' : 'å®¢';
          const cls = isUser ? 'message message-user' : 'message message-bot';
          const rawText = (m.content || '');
          const safeText = rawText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const hasImage = !!m.image;
          const isProductLinkMsg = hasImage && /^æˆ‘æƒ³å’¨è¯¢è¿™ä¸ªå•†å“ï¼š/i.test(rawText.trim());
          let body = '';
          if (isProductLinkMsg) {
            // è§£æã€Œæˆ‘æƒ³å’¨è¯¢è¿™ä¸ªå•†å“ï¼šæ ‡é¢˜ Â¥xxã€å¹¶æ¸²æŸ“ä¸ºå•†å“å¡ç‰‡ï¼ˆæ¶ˆæ¯é‡Œå±•ç¤ºï¼Œåç»­æ–°æ¶ˆæ¯ä¼šæŠŠå®ƒé¡¶ä¸Šå»ï¼‰
            const t = rawText.trim().replace(/^æˆ‘æƒ³å’¨è¯¢è¿™ä¸ªå•†å“ï¼š\s*/i, '');
            const match = t.match(/^(.*?)(\s+Â¥\s*[\d.]+)?$/);
            const title = (match && match[1] ? match[1].trim() : t).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const price = (match && match[2] ? match[2].trim() : '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            body += '<p style="margin: 0 0 8px 0;">æˆ‘æƒ³å’¨è¯¢è¿™ä¸ªå•†å“ï¼š</p>';
            body += '<div class="message-product-card">';
            body += '<div class="message-product-image"><img src="' + String(m.image).replace(/"/g, '&quot;') + '" alt="' + title + '" /></div>';
            body += '<div class="message-product-info">';
            body += '<div class="message-product-title">' + title + '</div>';
            body += '<div class="message-product-price">' + (price || '') + '</div>';
            body += '</div></div>';
          } else {
            if (rawText && rawText.trim()) body += '<p style="margin: 0;">' + safeText + '</p>';
            if (hasImage) body += '<div class="image-preview-container"><img src="' + String(m.image).replace(/"/g, '&quot;') + '" alt="å›¾ç‰‡" class="message-image" /></div>';
            if (!body) body = '<p style="margin: 0; color: #999;">ï¼ˆç©ºæ¶ˆæ¯ï¼‰</p>';
          }
          return '<div class="' + rowClass + '"><span class="' + avatarClass + '">' + avatarLetter + '</span><div class="' + cls + '">' + body + '</div></div>';
        }).join('');
        const chatBody = document.querySelector('.chat-body');
        if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;
      }

      function loadCustomerMessages() {
        if (!BACKEND || !customerLoggedIn) return;
        fetch(BACKEND + '/api/customer/messages', { credentials: 'include' })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data && data.ok && Array.isArray(data.items)) renderChatMessages(data.items);
          })
          .catch(function() {});
      }

      function initCustomerChat() {
        if (!BACKEND) return;
        fetch(BACKEND + '/api/auth/me', { credentials: 'include' })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (!data || !data.ok || !data.user) {
              customerLoggedIn = false;
              var list = document.getElementById('chatMessageList');
              if (list) {
                list.innerHTML = '<div class="message message-bot"><p style="margin: 0; color: #666;">è¯·å…ˆ<a href="login.html?redirect=' + encodeURIComponent(window.location.href) + '">ç™»å½•</a>åå†ä¸å®¢æœäº¤æµã€‚</p></div>';
              }
              return;
            }
            customerLoggedIn = true;
            fetch(BACKEND + '/api/customer/conversation', { credentials: 'include' })
              .then(function(r) { return r.json(); })
              .then(function() {
                loadCustomerMessages();
                autoSendProductLink();
              })
              .catch(function() { loadCustomerMessages(); autoSendProductLink(); });
            if (customerMessagePollTimer) clearInterval(customerMessagePollTimer);
            customerMessagePollTimer = setInterval(loadCustomerMessages, 3000);
          })
          .catch(function() {});
      }
      document.addEventListener('DOMContentLoaded', initCustomerChat);

      // å•†å“ä¿¡æ¯ï¼ˆé»˜è®¤å®‰å²³æ–°é²œæŸ æª¬ï¼›è‹¥ URL å¸¦ id/title/price/image åˆ™åˆ·æ–°ä¸ºæ–°å•†å“ï¼‰
      const productInfo = {
        id: 'fresh-1',
        title: 'å®‰å²³æ–°é²œæŸ æª¬',
        price: 'Â¥19.90',
        image: 'https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=fresh%20lemon%20fruit%20on%20white%20background&image_size=square',
        link: window.location.href
      };

      function applyProductFromUrl() {
        var params = new URLSearchParams(window.location.search);
        var id = params.get('id');
        var title = params.get('title');
        var price = params.get('price');
        var image = params.get('image');
        if (id) productInfo.id = id;
        if (title) productInfo.title = decodeURIComponent(title);
        if (price) productInfo.price = decodeURIComponent(price);
        if (image) productInfo.image = decodeURIComponent(image);
      }
      document.addEventListener('DOMContentLoaded', applyProductFromUrl);

      function autoSendProductLink() {
        var params = new URLSearchParams(window.location.search);
        if (!params.get('id') && !params.get('title') && !params.get('price') && !params.get('image')) return;
        if (!customerLoggedIn || !BACKEND) return;
        applyProductFromUrl();
        var ts = params.get('ts') || '';
        // ä¼˜å…ˆç”¨ ts æ ‡è®°ä¸€æ¬¡å’¨è¯¢ï¼Œé¿å…åˆ·æ–°é‡å¤å‘é€ï¼›æ²¡æœ‰ ts æ—¶é€€å›åˆ°æŒ‰å•†å“ id é˜²é‡
        var key = 'customer_autosent_' + (ts || (productInfo.id || ''));
        try { if (sessionStorage.getItem(key)) return; } catch (e) {}
        var text = 'æˆ‘æƒ³å’¨è¯¢è¿™ä¸ªå•†å“ï¼š' + productInfo.title + ' ' + (productInfo.price || '');
        try { sessionStorage.setItem(key, '1'); } catch (e) {}
        fetch(BACKEND + '/api/customer/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            content: text,
            image: productInfo.image || null,
            productId: productInfo.id || null
          })
        }).then(function(r) { return r.json(); }).then(function() { loadCustomerMessages(); }).catch(function() {});
      }

      // å’¨è¯¢é€‰é¡¹ç‚¹å‡»äº‹ä»¶
      const actionChips = document.querySelectorAll('.action-chip');
      
      actionChips.forEach(chip => {
        chip.addEventListener('click', function() {
          const optionValue = this.dataset.value;
          const chatInput = document.querySelector('.chat-input');
          
          // ç®€å•çš„ç‚¹å‡»åé¦ˆåŠ¨ç”»
          this.style.transform = 'scale(0.95)';
          setTimeout(() => {
            this.style.transform = '';
          }, 150);
          
          let consultMessage = '';
          switch(optionValue) {
            case 'price':
              consultMessage = 'æˆ‘æƒ³äº†è§£ä¸€ä¸‹è¿™ä¸ªå•†å“çš„ä»·æ ¼ï¼Œæœ‰ä»€ä¹ˆä¼˜æƒ æ´»åŠ¨å—ï¼Ÿ';
              break;
            case 'spec':
              consultMessage = 'è¯·é—®è¿™ä¸ªå•†å“æœ‰å“ªäº›è§„æ ¼å¯ä»¥é€‰æ‹©ï¼Ÿ';
              break;
            case 'delivery':
              consultMessage = 'è¯·é—®è¿™ä¸ªå•†å“çš„é…é€æ–¹å¼å’Œæ—¶é—´æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ';
              break;
          }
          
          // è‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†å¹¶å‘é€
          chatInput.value = consultMessage;
          chatInput.focus();
          setTimeout(function() { sendMessage(consultMessage); }, 300);
        });
      });

      // å‘é€æ¶ˆæ¯å‡½æ•°ï¼ˆä¸å®¢æœå®æ—¶æ²Ÿé€šï¼šå‘é€åˆ°åç«¯ï¼Œè½®è¯¢è·å–å®¢æœå›å¤ï¼‰
      async function sendMessage(messageText, imageData) {
        if (!messageText || !String(messageText).trim()) {
          if (!imageData) return;
        }
        if (!customerLoggedIn || !BACKEND) {
          alert('è¯·å…ˆç™»å½•åå†å‘é€æ¶ˆæ¯');
          return;
        }
        var chatMessageList = document.getElementById('chatMessageList');
        var chatBody = document.querySelector('.chat-body');
        var input = document.getElementById('chatInput');
        var row = document.createElement('div');
        row.className = 'message-row message-row--right';
        var avatar = document.createElement('span');
        avatar.className = 'message-avatar message-avatar--user';
        avatar.textContent = 'æˆ‘';
        var userMessage = document.createElement('div');
        userMessage.className = 'message message-user';
        var messageHTML = '';
        if (messageText && String(messageText).trim()) {
          messageHTML += '<p style="margin: 0;">' + String(messageText).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>';
        }
        if (imageData) {
          messageHTML += '<div class="image-preview-container"><img src="' + imageData + '" alt="ä¸Šä¼ çš„å›¾ç‰‡" class="message-image" /></div>';
        }
        userMessage.innerHTML = messageHTML;
        row.appendChild(avatar);
        row.appendChild(userMessage);
        if (chatMessageList) chatMessageList.appendChild(row);
        input.value = '';
        window.currentImageData = null;
        var imagePreview = document.getElementById('imagePreview');
        if (imagePreview) imagePreview.remove();
        var imageUpload = document.getElementById('imageUpload');
        if (imageUpload) imageUpload.value = '';
        if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;
        try {
          var payload = { content: messageText || '', image: imageData || null, productId: productInfo && productInfo.id ? productInfo.id : null };
          var resp = await fetch(BACKEND + '/api/customer/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
          var data = await resp.json().catch(function() { return null; });
          if (!data || !data.ok) {
            if (data && data.error && data.error.indexOf('ç™»å½•') !== -1) {
              customerLoggedIn = false;
              initCustomerChat();
            }
            console.warn('æ¶ˆæ¯å‘é€å¤±è´¥', data && data.error);
            return;
          }
          loadCustomerMessages();
        } catch (err) {
          console.error('å‘é€æ¶ˆæ¯å¤±è´¥', err);
        }
      }

      // è¡¨æƒ…æ•°æ®
      const emojis = [
        'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£',
        'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°',
        'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ',
        'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜',
        'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'ğŸ˜£', 'ğŸ˜–',
        'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡',
        'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°',
        'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶',
        'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®',
        'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´',
        'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ',
        'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™',
        'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’ª',
        'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤',
        'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–',
        'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰', 'â˜¸ï¸',
        'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ',
        'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™',
        'â™‘', 'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'ğŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸'
      ];

      // åˆå§‹åŒ–è¡¨æƒ…é€‰æ‹©å™¨
      const emojiPicker = document.getElementById('emojiPicker');
      const emojiGrid = document.getElementById('emojiGrid');
      const emojiBtn = document.getElementById('emojiBtn');
      const chatInput = document.getElementById('chatInput');
      
      // æ¸²æŸ“è¡¨æƒ…
      emojis.forEach(emoji => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.textContent = emoji;
        emojiItem.addEventListener('click', function() {
          const cursorPos = chatInput.selectionStart;
          const textBefore = chatInput.value.substring(0, cursorPos);
          const textAfter = chatInput.value.substring(cursorPos);
          chatInput.value = textBefore + emoji + textAfter;
          chatInput.focus();
          chatInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
          emojiPicker.classList.remove('emoji-picker--show');
        });
        emojiGrid.appendChild(emojiItem);
      });

      // è¡¨æƒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      emojiBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        emojiPicker.classList.toggle('emoji-picker--show');
      });

      // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
      document.addEventListener('click', function(e) {
        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
          emojiPicker.classList.remove('emoji-picker--show');
        }
      });

      // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
      const imageBtn = document.getElementById('imageBtn');
      const imageUpload = document.getElementById('imageUpload');
      window.currentImageData = null; // ä½¿ç”¨windowå¯¹è±¡ä½¿å…¶å…¨å±€å¯è®¿é—®

      imageBtn.addEventListener('click', function() {
        imageUpload.click();
      });

      imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
          alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
        if (file.size > 5 * 1024 * 1024) {
          alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼');
          return;
        }

        // è¯»å–å›¾ç‰‡å¹¶æ˜¾ç¤ºé¢„è§ˆ
        const reader = new FileReader();
        reader.onload = function(e) {
          window.currentImageData = e.target.result;
          
          // ç§»é™¤æ—§çš„é¢„è§ˆ
          const oldPreview = document.getElementById('imagePreview');
          if (oldPreview) {
            oldPreview.remove();
          }

          // åˆ›å»ºé¢„è§ˆ
          const previewContainer = document.createElement('div');
          previewContainer.id = 'imagePreview';
          previewContainer.className = 'image-preview-container';
          previewContainer.style.cssText = 'margin-top: 12px; margin-left: 48px;';
          
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'image-remove';
          removeBtn.textContent = 'Ã—';
          removeBtn.addEventListener('click', function() {
            previewContainer.remove();
            window.currentImageData = null;
            imageUpload.value = '';
          });
          
          const img = document.createElement('img');
          img.src = window.currentImageData;
          img.alt = 'é¢„è§ˆå›¾ç‰‡';
          img.className = 'image-preview';
          
          previewContainer.appendChild(img);
          previewContainer.appendChild(removeBtn);
          
          const inputContainer = document.querySelector('.input-container');
          inputContainer.appendChild(previewContainer);
        };
        reader.readAsDataURL(file);
      });

      // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById('sendBtn').addEventListener('click', function() {
        const message = chatInput.value.trim();
        sendMessage(message, window.currentImageData);
        // æ¸…ç©ºå›¾ç‰‡æ•°æ®å’Œé¢„è§ˆ
        window.currentImageData = null;
        imageUpload.value = '';
        const preview = document.getElementById('imagePreview');
        if (preview) {
          preview.remove();
        }
      });

      // å›è½¦å‘é€æ¶ˆæ¯
      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const message = this.value.trim();
          if (message || window.currentImageData) {
            sendMessage(message, window.currentImageData);
            // æ¸…ç©ºå›¾ç‰‡æ•°æ®å’Œé¢„è§ˆ
            window.currentImageData = null;
            imageUpload.value = '';
            const preview = document.getElementById('imagePreview');
            if (preview) {
              preview.remove();
            }
          }
        }
      });
    </script>
  </body>
</html>