<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>çŸ³åˆ»æŠ¤æŸ  Â· å¤©æ°”</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      /* å¤©æ°”å¡ç‰‡æ·¡å…¥åŠ¨ç”» */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .weather-fade-in {
        animation: fadeInUp 0.5s ease-out;
      }
      
      /* æ‚¬æµ®æç¤ºæ ·å¼ - å·²åœ¨ä¸Šé¢å®šä¹‰ï¼Œè¿™é‡Œä¿ç•™å·¥å…·æç¤ºæ ·å¼ */
      .wxMetric__tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(45, 35, 25, 0.95);
        color: #fff;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.5;
        width: 220px;
        text-align: left;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-bottom: 8px;
      }
      .wxMetric__tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: rgba(45, 35, 25, 0.95);
      }
      .wxMetric:hover .wxMetric__tooltip {
        opacity: 1;
        visibility: visible;
      }
      .wxMetric__tooltip-title {
        font-weight: 600;
        color: #FFD54F;
        margin-bottom: 6px;
        font-size: 14px;
      }
      
      /* æ›´æ–°æ—¶é—´æ˜¾ç¤º */
      .weather-update {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 16px;
        font-size: 13px;
        color: var(--muted);
      }
      .weather-update__refresh {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 8px;
        transition: all 0.3s ease;
        user-select: none;
      }
      .weather-update__refresh:hover {
        background: rgba(200, 176, 106, 0.1);
        color: var(--accent2);
      }
      .weather-update__refresh:active {
        transform: scale(0.95);
      }
      .weather-update__icon {
        width: 16px;
        height: 16px;
        animation: spin 2s linear infinite;
        animation-play-state: paused;
        transition: transform 0.3s ease;
      }
      .weather-update__refresh:hover .weather-update__icon {
        transform: rotate(180deg);
      }
      .weather-update__icon--loading {
        animation-play-state: running;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      /* å°æŸ ä»Šæ—¥ç”Ÿå­˜æŠ¥å‘Š */
      .survival-report {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(247, 243, 234, 0.9) 100%);
        border-radius: 20px;
        padding: 32px;
        margin-bottom: 28px;
        box-shadow: 0 4px 20px rgba(33, 24, 10, 0.1);
        border: 1px solid rgba(200, 176, 106, 0.2);
      }
      .report-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(160, 140, 90, 0.2);
      }
      .report-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--ink);
        margin: 0 0 8px 0;
        letter-spacing: 0.06em;
      }
      .report-date {
        font-size: 14px;
        color: var(--muted);
        letter-spacing: 0.04em;
      }
      
      /* æŸ æª¬çŠ¶æ€ */
      .lemon-status {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 24px;
        background: linear-gradient(135deg, rgba(200, 176, 106, 0.18), rgba(200, 176, 106, 0.1));
        border-radius: 16px;
        margin-bottom: 28px;
        border-left: 5px solid var(--accent);
        box-shadow: 0 2px 12px rgba(200, 176, 106, 0.15);
        transition: all 0.3s ease;
      }
      .lemon-status:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 16px rgba(200, 176, 106, 0.2);
      }
      .lemon-status__icon {
        font-size: 56px;
        line-height: 1;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }
      .lemon-status__text {
        flex: 1;
        font-size: 18px;
        color: var(--ink);
        line-height: 1.7;
        font-style: italic;
        font-weight: 500;
        letter-spacing: 0.02em;
      }
      
      /* ä»Šæ—¥å…³é”®å¤©æ°” */
      .weather-key {
        margin-bottom: 24px;
      }
      .weather-key__title {
        font-size: 18px;
        font-weight: 600;
        color: var(--ink);
        margin: 0 0 20px 0;
        letter-spacing: 0.06em;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .weather-key__content {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(247, 243, 234, 0.9) 100%);
        border: 1px solid rgba(200, 176, 106, 0.25);
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 4px 20px rgba(33, 24, 10, 0.08);
        transition: all 0.3s ease;
      }
      .weather-key__content:hover {
        box-shadow: 0 6px 24px rgba(33, 24, 10, 0.12);
        border-color: rgba(200, 176, 106, 0.35);
      }
      .weather-key__main {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 28px;
        padding-bottom: 24px;
        border-bottom: 2px solid rgba(200, 176, 106, 0.2);
      }
      .weather-key__icon {
        width: 72px;
        height: 72px;
        color: var(--accent2);
        flex-shrink: 0;
        background: linear-gradient(135deg, rgba(200, 176, 106, 0.15), rgba(200, 176, 106, 0.08));
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
      }
      .weather-key__icon svg {
        width: 100%;
        height: 100%;
      }
      .weather-key__main-info {
        flex: 1;
      }
      .weather-key__desc {
        font-size: 18px;
        color: var(--muted);
        margin-bottom: 12px;
        font-weight: 500;
        letter-spacing: 0.04em;
      }
      .weather-key__temp {
        font-size: 48px;
        font-weight: 700;
        color: var(--accent);
        letter-spacing: 0.02em;
        line-height: 1;
        font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      }
      .weather-key__metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      .wxMetric {
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(200, 176, 106, 0.2);
        border-radius: 12px;
        padding: 18px 16px;
        transition: all 0.3s ease;
        position: relative;
        cursor: help;
      }
      .wxMetric:hover {
        transform: translateY(-3px);
        background: rgba(255, 255, 255, 0.95);
        border-color: rgba(200, 176, 106, 0.4);
        box-shadow: 0 4px 12px rgba(200, 176, 106, 0.15);
      }
      .wxMetric__label {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 10px;
        font-weight: 500;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }
      .wxMetric__value {
        font-size: 22px;
        font-weight: 700;
        color: var(--accent2);
        font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
        letter-spacing: 0.02em;
      }
      
      /* å†å²è®°å½•ä¸æˆå°± */
      .history-section {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(247, 243, 234, 0.9) 100%);
        border-radius: 20px;
        padding: 32px;
        margin-bottom: 28px;
        box-shadow: 0 4px 20px rgba(33, 24, 10, 0.1);
        border: 1px solid rgba(200, 176, 106, 0.2);
      }
      .history-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--ink);
        margin: 0 0 20px 0;
        letter-spacing: 0.06em;
      }
      .history-days {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }
      .history-day {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(200, 176, 106, 0.25);
        border-radius: 12px;
        padding: 20px 16px;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(33, 24, 10, 0.05);
      }
      .history-day:hover {
        background: rgba(255, 255, 255, 0.95);
        border-color: rgba(200, 176, 106, 0.4);
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(200, 176, 106, 0.2);
      }
      .history-day__date {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 12px;
        font-weight: 500;
        letter-spacing: 0.04em;
      }
      .history-day__icon {
        font-size: 36px;
        margin-bottom: 12px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }
      .history-day__temp {
        font-size: 20px;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 6px;
        font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      }
      .history-day__desc {
        font-size: 13px;
        color: var(--muted);
        font-weight: 500;
      }
      
      @media (max-width: 620px) {
        .weather-key__metrics {
          grid-template-columns: 1fr;
        }
        .history-days {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar__inner">
        <a class="brand" href="index.html" aria-label="è¿”å›å•†å“é¡µ">
          <img class="brand__logo" src="assets/logo.png" alt="çŸ³åˆ»æŠ¤æŸ  Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
          <span class="brand__text" style="display:none;">çŸ³åˆ»æŠ¤æŸ </span>
        </a>

        <nav class="nav">
          <a class="nav__item nav__item--active" href="weather.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M7.5 18.5h10.2a4.3 4.3 0 0 0 .5-8.6A6.2 6.2 0 0 0 6.1 8.4 4.4 4.4 0 0 0 7.5 18.5Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            å¤©æ°”
          </a>
          <a class="nav__item" href="index.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M7.5 8.2V7a4.5 4.5 0 0 1 9 0v1.2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M6.3 8.2h11.4l1 12.5H5.3l1-12.5Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
            </span>
            å•†å“
          </a>
          <a class="nav__item" href="activate.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M6.6 4.8h9.7a2.2 2.2 0 0 1 2.2 2.2v12.2a2.2 2.2 0 0 0-2.2-2.2H6.6a2.2 2.2 0 0 0-2.2 2.2V7a2.2 2.2 0 0 1 2.2-2.2Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M8.2 7.6h7.1M8.2 10.4h7.1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            </span>
            æ´»åŠ¨
          </a>
          <a class="nav__item" href="store.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="9" r="2.5" stroke="currentColor" stroke-width="1.6"/></svg>
            </span>
            é—¨åº—
          </a>
        </nav>

        <div class="topbar__right">
          <a class="toplink" href="favorites.html">æˆ‘çš„æ”¶è—</a>
          <div class="topbar__auth" id="authArea">
            <a class="toplink" href="login.html" id="authLink">ç™»å½•æ³¨å†Œ</a>
          </div>
        </div>
      </div>
      <div class="topbar__divider"></div>
    </header>

    <main class="page">
      <section class="hero container">
        <h1 class="hero__title">æŸ æª¬ç”Ÿé•¿æ—¥è®°</h1>
      </section>

      <section class="container">
        <!-- å°æŸ ä»Šæ—¥ç”Ÿå­˜æŠ¥å‘Š -->
        <div class="survival-report" id="survivalReport">
          <div class="report-header">
            <h2 class="report-title">å°æŸ ä»Šæ—¥ç”Ÿå­˜æŠ¥å‘Š</h2>
            <div class="report-date" id="reportDate">ğŸ“… 2023å¹´10æœˆ27æ—¥ æ˜ŸæœŸå››</div>
          </div>

          <!-- æŸ æª¬çŠ¶æ€ -->
          <div class="lemon-status" id="lemonStatus">
            <div class="lemon-status__icon">ğŸ‹</div>
            <div class="lemon-status__text" id="lemonStatusText">å–é¥±äº†æ°´ï¼Œæ­£åœ¨æƒ¬æ„å‘¼å¸~</div>
          </div>

          <!-- ä»Šæ—¥å…³é”®å¤©æ°” -->
          <div class="weather-key" id="weatherCard">
            <h3 class="weather-key__title">ğŸŒ¤ï¸ ä»Šæ—¥å…³é”®å¤©æ°”</h3>
            <div class="weather-key__content">
              <div class="weather-key__main">
                <div class="weather-key__icon">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 3.3v2.2M12 18.5v2.2M3.3 12h2.2M18.5 12h2.2M5.4 5.4l1.6 1.6M17 17l1.6 1.6M18.6 5.4 17 7M7 17l-1.6 1.6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    <path d="M12 16.2a4.2 4.2 0 1 0 0-8.4 4.2 4.2 0 0 0 0 8.4Z" stroke="currentColor" stroke-width="1.6"/>
                  </svg>
                </div>
                <div class="weather-key__main-info">
                  <div class="weather-key__desc" id="wxDesc">æ™´å¤©</div>
                  <div class="weather-key__temp"><span id="wxTemp">24</span><span class="wxTemp__unit">Â°C</span></div>
                </div>
              </div>
              <div class="weather-key__metrics">
                <div class="wxMetric" id="humMetric">
                  <div class="wxMetric__label">æ¹¿åº¦</div>
                  <div class="wxMetric__value" id="wxHum">65%</div>
                  <div class="wxMetric__tooltip">
                    <div class="wxMetric__tooltip-title">æ¹¿åº¦å½±å“</div>
                    <div id="humTip">å½“å‰æ¹¿åº¦é€‚ä¸­ï¼Œæœ‰åˆ©äºæŸ æª¬æ­£å¸¸ç”Ÿé•¿ã€‚</div>
                  </div>
                </div>
                <div class="wxMetric" id="rainMetric">
                  <div class="wxMetric__label">é™æ°´é‡</div>
                  <div class="wxMetric__value" id="wxRain">0mm</div>
                  <div class="wxMetric__tooltip">
                    <div class="wxMetric__tooltip-title">é™æ°´å»ºè®®</div>
                    <div id="rainTip">æ— é™æ°´ï¼Œéœ€æ³¨æ„é€‚æ—¶çŒæº‰ä¿æŒåœŸå£¤æ¹¿æ¶¦ã€‚</div>
                  </div>
                </div>
                <div class="wxMetric" id="windDirMetric">
                  <div class="wxMetric__label">é£å‘</div>
                  <div class="wxMetric__value" id="wxWindDir">å—é£</div>
                  <div class="wxMetric__tooltip">
                    <div class="wxMetric__tooltip-title">é£å‘è¯´æ˜</div>
                    <div id="windDirTip">å—é£å¸¦æ¥æ¸©æš–æ¹¿æ¶¦çš„ç©ºæ°”ï¼Œæœ‰åˆ©äºæŸ æª¬ç”Ÿé•¿ã€‚</div>
                  </div>
                </div>
                <div class="wxMetric" id="windSpeedMetric">
                  <div class="wxMetric__label">é£é€Ÿ</div>
                  <div class="wxMetric__value" id="wxWindSpeed">4km/h</div>
                  <div class="wxMetric__tooltip">
                    <div class="wxMetric__tooltip-title">é£é€Ÿå½±å“</div>
                    <div id="windSpeedTip">å¾®é£æœ‰åˆ©äºç©ºæ°”æµé€šï¼Œå‡å°‘ç—…è™«å®³å‘ç”Ÿã€‚</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æŸ å‘³7æ—¥æ™´é›¨è¡¨ -->
        <div class="history-section">
          <h3 class="history-title">æŸ å‘³7æ—¥æ™´é›¨è¡¨</h3>
          <div class="history-days" id="historyDays">
            <!-- è¿‡å»7å¤©çš„å¤©æ°”è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- æ›´æ–°æ—¶é—´æ˜¾ç¤º -->
        <div class="weather-update">
          <div class="weather-update__refresh" id="refreshBtn" title="ç‚¹å‡»æ‰‹åŠ¨åˆ·æ–°">
            <svg class="weather-update__icon" id="refreshIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 4v6h-6M1 20v-6h6"/>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
            </svg>
            <span>ä¸Šæ¬¡æ›´æ–°ï¼š<span id="updateTime">--</span></span>
          </div>
          <span style="margin-left: 8px; color: rgba(160, 140, 90, 0.6);">ï¼ˆæ¯å°æ—¶è‡ªåŠ¨åˆ·æ–°ï¼Œç‚¹å‡»å›¾æ ‡æ‰‹åŠ¨åˆ·æ–°ï¼‰</span>
        </div>
      </section>
    </main>

    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
      // å¤©æ°”æ•°æ®ç®¡ç†
      const WeatherManager = {
        // è·å–æŸ æª¬çŠ¶æ€ï¼ˆæ‹ŸäººåŒ–æè¿°ï¼‰
        getLemonStatus(temp, humidity) {
          const t = parseInt(temp);
          const h = parseInt(humidity);
          
          // æ ¹æ®æ¸©åº¦å’Œæ¹¿åº¦ç»„åˆç”Ÿæˆæ‹ŸäººåŒ–æè¿°
          if (t >= 20 && t <= 28 && h >= 50 && h <= 80) {
            return "å–é¥±äº†æ°´ï¼Œæ­£åœ¨æƒ¬æ„å‘¼å¸~";
          } else if (h >= 90) {
            return "ç©ºæ°”å¤ªæ¹¿æ¶¦äº†ï¼Œæœ‰ç‚¹é€ä¸è¿‡æ°”...";
          } else if (h < 30) {
            return "å¥½æ¸´å•Šï¼Œéœ€è¦å¤šå–ç‚¹æ°´~";
          } else if (t >= 35) {
            return "å¤ªçƒ­äº†ï¼Œéœ€è¦é®é˜´é™æ¸©~";
          } else if (t < 10) {
            return "å¥½å†·å•Šï¼Œéœ€è¦ä¿æš–~";
          } else if (t >= 28 && t < 35) {
            return "æœ‰ç‚¹çƒ­ï¼Œä½†è¿˜èƒ½åšæŒ~";
          } else if (t >= 10 && t < 20) {
            return "æœ‰ç‚¹å‡‰ï¼Œç”Ÿé•¿å˜æ…¢äº†~";
          } else {
            return "çŠ¶æ€è‰¯å¥½ï¼Œæ­£åœ¨åŠªåŠ›æˆé•¿~";
          }
        },
        
        // è·å–æ‚¬æµ®æç¤ºæ–‡æœ¬
        getHumidityTip(humidity) {
          const h = parseInt(humidity);
          if (h >= 90) return `æ¹¿åº¦${humidity}ï¼šæŸ æª¬å¶ç‰‡æ˜“ç»“éœ²ï¼Œéœ€åŠ å¼ºé€šé£é¿å…ç—…å®³ï¼Œé˜²æ­¢çœŸèŒæ»‹ç”Ÿã€‚`;
          if (h >= 70) return `æ¹¿åº¦${humidity}ï¼šæ¹¿åº¦åé«˜ï¼Œæ³¨æ„è§‚å¯Ÿå¶ç‰‡çŠ¶å†µï¼Œä¿æŒè‰¯å¥½é€šé£ã€‚`;
          if (h >= 50) return `æ¹¿åº¦${humidity}ï¼šå½“å‰æ¹¿åº¦é€‚ä¸­ï¼Œæœ‰åˆ©äºæŸ æª¬æ­£å¸¸ç”Ÿé•¿å’Œæœå®å‘è‚²ã€‚`;
          if (h >= 30) return `æ¹¿åº¦${humidity}ï¼šæ¹¿åº¦åä½ï¼Œéœ€é€‚å½“å¢åŠ çŒæº‰ï¼Œé˜²æ­¢å¶ç‰‡æ°´åˆ†æµå¤±ã€‚`;
          return `æ¹¿åº¦${humidity}ï¼šç©ºæ°”å¹²ç‡¥ï¼Œå»ºè®®å–·æ°´å¢æ¹¿ï¼Œé¿å…æŸ æª¬å¶ç‰‡å¹²æ¯ã€‚`;
        },
        
        getTempTip(temp) {
          const t = parseInt(temp);
          if (t >= 35) return `æ¸©åº¦${temp}Â°Cï¼šé«˜æ¸©å¤©æ°”ï¼Œéœ€é®é˜´é™æ¸©ï¼Œå¢åŠ çŒæº‰é¢‘æ¬¡ï¼Œé˜²æ­¢æ—¥ç¼ã€‚`;
          if (t >= 28) return `æ¸©åº¦${temp}Â°Cï¼šæ¸©åº¦è¾ƒé«˜ï¼Œæ³¨æ„ä¿æŒåœŸå£¤æ¹¿æ¶¦ï¼Œä¸­åˆå¯é€‚å½“é®é˜´ã€‚`;
          if (t >= 20) return `æ¸©åº¦${temp}Â°Cï¼šæœ€é€‚å®œæŸ æª¬ç”Ÿé•¿çš„æ¸©åº¦ï¼Œä¿æŒæ­£å¸¸ç®¡ç†å³å¯ã€‚`;
          if (t >= 10) return `æ¸©åº¦${temp}Â°Cï¼šæ¸©åº¦åä½ï¼ŒæŸ æª¬ç”Ÿé•¿æ”¾ç¼“ï¼Œæ³¨æ„ä¿æ¸©é˜²å¯’ã€‚`;
          return `æ¸©åº¦${temp}Â°Cï¼šä½æ¸©è­¦å‘Šï¼éœ€é‡‡å–é˜²å†»æªæ–½ï¼Œè¦†ç›–ä¿æ¸©ææ–™ã€‚`;
        },
        
        getRainTip(rain) {
          const r = parseFloat(rain);
          if (r >= 50) return `é™æ°´é‡${rain}ï¼šæš´é›¨å¤©æ°”ï¼Œæ³¨æ„æ’æ°´é˜²æ¶ï¼Œé˜²æ­¢æ ¹ç³»ç¼ºæ°§è…çƒ‚ã€‚`;
          if (r >= 20) return `é™æ°´é‡${rain}ï¼šä¸­åˆ°å¤§é›¨ï¼Œæ£€æŸ¥æ’æ°´ç³»ç»Ÿï¼Œé¿å…ç§¯æ°´ã€‚`;
          if (r >= 5) return `é™æ°´é‡${rain}ï¼šå°åˆ°ä¸­é›¨ï¼Œå¤©ç„¶çŒæº‰æœ‰åˆ©äºæŸ æª¬å¸æ”¶æ°´åˆ†ã€‚`;
          if (r > 0) return `é™æ°´é‡${rain}ï¼šå°é›¨æ»‹æ¶¦ï¼Œæœ‰åˆ©äºæŸ æª¬æ–°å¶ç”Ÿé•¿ã€‚`;
          return `é™æ°´é‡${rain}ï¼šæ— é™æ°´ï¼Œéœ€æ³¨æ„é€‚æ—¶çŒæº‰ä¿æŒåœŸå£¤æ¹¿æ¶¦ã€‚`;
        },
        
        getWindDirTip(dir) {
          if (dir.includes('å—')) return `${dir}ï¼šå¸¦æ¥æ¸©æš–æ¹¿æ¶¦çš„ç©ºæ°”ï¼Œæœ‰åˆ©äºæŸ æª¬ç”Ÿé•¿ã€‚`;
          if (dir.includes('åŒ—')) return `${dir}ï¼šå¯èƒ½å¸¦æ¥å¹²å†·ç©ºæ°”ï¼Œæ³¨æ„é˜²å¯’ä¿æš–ã€‚`;
          if (dir.includes('ä¸œ')) return `${dir}ï¼šæµ·é£å¸¦æ¥æ¹¿æ¶¦æ°”æµï¼Œæœ‰åŠ©äºè°ƒèŠ‚æ¸©æ¹¿åº¦ã€‚`;
          if (dir.includes('è¥¿')) return `${dir}ï¼šå†…é™†æ°”æµï¼Œç©ºæ°”ç›¸å¯¹å¹²ç‡¥ï¼Œæ³¨æ„ä¿æ¹¿ã€‚`;
          return `${dir}ï¼šæ³¨æ„è§‚å¯Ÿå¤©æ°”å˜åŒ–ï¼ŒåŠæ—¶è°ƒæ•´ç®¡ç†æªæ–½ã€‚`;
        },
        
        getWindSpeedTip(speed) {
          const s = parseInt(speed);
          if (s >= 40) return `é£é€Ÿ${speed}ï¼šå¤§é£å¤©æ°”ï¼Œéœ€åŠ å›ºæ”¯æ’‘ï¼Œé˜²æ­¢ææ¡æŠ˜æ–­ã€‚`;
          if (s >= 20) return `é£é€Ÿ${speed}ï¼šé£åŠ›è¾ƒå¤§ï¼Œæ£€æŸ¥æœæ ‘æ”¯æ’‘æƒ…å†µï¼Œå¿…è¦æ—¶åŠ å›ºã€‚`;
          if (s >= 10) return `é£é€Ÿ${speed}ï¼šé€‚åº¦é£åŠ›ï¼Œæœ‰åˆ©äºèŠ±ç²‰ä¼ æ’­å’Œç©ºæ°”æµé€šã€‚`;
          return `é£é€Ÿ${speed}ï¼šå¾®é£æœ‰åˆ©äºç©ºæ°”æµé€šï¼Œå‡å°‘ç—…è™«å®³å‘ç”Ÿã€‚`;
        },
        
        // æ›´æ–°æ‚¬æµ®æç¤º
        updateTooltips(data) {
          const tempTipEl = document.getElementById('tempTip');
          if (tempTipEl) tempTipEl.textContent = this.getTempTip(data.temp);

          const humTipEl = document.getElementById('humTip');
          if (humTipEl) humTipEl.textContent = this.getHumidityTip(data.humidity);

          const rainTipEl = document.getElementById('rainTip');
          if (rainTipEl) rainTipEl.textContent = this.getRainTip(data.precip);

          const windDirTipEl = document.getElementById('windDirTip');
          if (windDirTipEl) windDirTipEl.textContent = this.getWindDirTip(data.windDir);

          const windSpeedTipEl = document.getElementById('windSpeedTip');
          if (windSpeedTipEl) windSpeedTipEl.textContent = this.getWindSpeedTip(data.windSpeed);
        },
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        formatDate(date) {
          const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
          const year = date.getFullYear();
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const day = date.getDate().toString().padStart(2, '0');
          const weekday = weekdays[date.getDay()];
          return `ğŸ“… ${year}å¹´${month}æœˆ${day}æ—¥ ${weekday}`;
        },
        
        // ä»å’Œé£å¤©æ°” 7 å¤©å¤©æ°”é¢„æŠ¥æ¥å£è·å–å†å² / æœªæ¥æ•°æ®
        async fetchHistoryFromApi() {
          if (typeof BACKEND_BASE_URL === 'undefined') {
            return null;
          }
          try {
            const resp = await fetch(`${BACKEND_BASE_URL}/api/weather/7d`);
            const raw = await resp.json();
            if (!raw || !raw.ok || !raw.data || !Array.isArray(raw.data.days)) {
              console.error('7 å¤©å¤©æ°”æ¥å£è¿”å›æ•°æ®å¼‚å¸¸', raw);
              return null;
            }
            return raw.data;
          } catch (e) {
            console.error('è·å– 7 å¤©å¤©æ°”é¢„æŠ¥å¤±è´¥', e);
            return null;
          }
        },

        // ç®€å•æŠŠå’Œé£ icon / æ–‡æœ¬æ˜ å°„æˆé¡µé¢ç”¨çš„è¡¨æƒ…
        mapWeatherToEmoji(text) {
          const t = text || '';
          if (t.includes('é›¨')) return 'ğŸŒ§ï¸';
          if (t.includes('é›ª')) return 'â„ï¸';
          if (t.includes('é›·')) return 'â›ˆï¸';
          if (t.includes('é›¾') || t.includes('éœ¾')) return 'ğŸŒ«ï¸';
          if (t.includes('å¤šäº‘') || t.includes('é˜´')) return 'â›…';
          if (t.includes('æ™´')) return 'â˜€ï¸';
          return 'â˜ï¸';
        },

        // æœ¬åœ°å…œåº•ï¼šéšæœºç”Ÿæˆ 7 å¤©æ•°æ®ï¼ˆå’Œä¹‹å‰é€»è¾‘ä¸€è‡´ï¼‰
        generateFallbackHistory() {
          const history = [];
          const today = new Date();
          const weathers = ['â˜€ï¸', 'â›…', 'ğŸŒ§ï¸', 'ğŸŒ«ï¸', 'â˜ï¸'];
          const descs = ['æ™´å¤©', 'å¤šäº‘', 'é›¨å¤©', 'é›¾å¤©', 'é˜´å¤©'];

          for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const random = Math.floor(Math.random() * weathers.length);
            history.push({
              date,
              icon: weathers[random],
              desc: descs[random],
              tempMin: Math.floor(Math.random() * 8) + 15,   // 15-22 åº¦
              tempMax: Math.floor(Math.random() * 8) + 23,   // 23-30 åº¦
            });
          }

          return history.map((d) => ({
            dateStr: `${(d.date.getMonth() + 1).toString().padStart(2, '0')}/${d.date.getDate().toString().padStart(2, '0')}`,
            icon: d.icon,
            desc: d.desc,
            tempRange: `${d.tempMin}~${d.tempMax}Â°C`,
          }));
        },
        
        // æ¸²æŸ“å†å²è®°å½•ï¼ˆä¼˜å…ˆä½¿ç”¨åç«¯æ¥å£æ•°æ®ï¼‰
        async renderHistory() {
          const historyDays = document.getElementById('historyDays');
          if (!historyDays) return;

          let historyCards = [];

          // ä¼˜å…ˆå°è¯•é€šè¿‡åç«¯ API è·å– 7 å¤©é¢„æŠ¥
          const apiData = await this.fetchHistoryFromApi();
          if (apiData && Array.isArray(apiData.days)) {
            historyCards = apiData.days.slice(0, 7).map((d) => {
              const dateObj = new Date(d.date);
              const dateStr = `${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')}`;
              const text = d.textDay || d.textNight || '';
              const icon = this.mapWeatherToEmoji(text);
              const tempRange = `${d.tempMin}~${d.tempMax}Â°C`;
              return {
                dateStr,
                icon,
                desc: text,
                tempRange,
              };
            });
          } else {
            // æ¥å£ä¸å¯ç”¨æ—¶ä½¿ç”¨æœ¬åœ°éšæœºæ•°æ®å…œåº•ï¼Œé˜²æ­¢é¡µé¢ç©ºç™½
            historyCards = this.generateFallbackHistory();
          }

          historyDays.innerHTML = historyCards
            .map((day) => {
              return `
                <div class="history-day">
                  <div class="history-day__date">${day.dateStr}</div>
                  <div class="history-day__icon">${day.icon}</div>
                  <div class="history-day__temp">${day.tempRange}</div>
                  <div class="history-day__desc">${day.desc}</div>
                </div>
              `;
            })
            .join('');
        },
        
        // åˆ·æ–°å¤©æ°”æ•°æ®ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        async refreshWeather() {
          const card = document.getElementById('weatherCard');
          const refreshIcon = document.getElementById('refreshIcon');
          
          // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
          if (refreshIcon) {
            refreshIcon.classList.add('weather-update__icon--loading');
          }
          
          try {
            const useBackend = typeof BACKEND_BASE_URL !== 'undefined';
            const url = useBackend
              ? `${BACKEND_BASE_URL}/api/weather/now`
              : 'js/weather_data.json';

            const resp = await fetch(url);
            const raw = await resp.json();
            const data = useBackend && raw && raw.ok ? raw.data : raw;
            
            if (!data) {
              console.error('å¤©æ°”æ•°æ®ä¸ºç©º', raw);
              return;
            }
            
            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            if (card) {
              card.classList.remove('weather-fade-in');
              void card.offsetWidth; // è§¦å‘é‡ç»˜
              card.classList.add('weather-fade-in');
            }
            
            // æ›´æ–°æ—¥æœŸ
            const now = new Date();
            const reportEl = document.getElementById('reportDate');
            if (reportEl) reportEl.textContent = this.formatDate(now);
            
            // æ›´æ–°æŸ æª¬çŠ¶æ€
            const lemonStatus = this.getLemonStatus(data.temp, data.humidity);
            const lemonEl = document.getElementById('lemonStatusText');
            if (lemonEl) lemonEl.textContent = lemonStatus;
            
            // æ›´æ–°å¤©æ°”æ•°æ®
            const setText = (id, v) => {
              const el = document.getElementById(id);
              if (el && v != null) el.textContent = v;
            };
            setText('wxTemp', data.temp);
            setText('wxDesc', data.desc);
            setText('wxHum', data.humidity);
            setText('wxRain', data.precip);
            setText('wxWindDir', data.windDir);
            setText('wxWindSpeed', data.windSpeed);
            
            // æ›´æ–°æç¤º
            this.updateTooltips(data);
            
            // æ›´æ–°æ—¶é—´
            const timeEl = document.getElementById('updateTime');
            if (timeEl) {
              timeEl.textContent =
                `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }
          } catch (error) {
            console.error('è·å–å¤©æ°”æ•°æ®å¤±è´¥:', error);
          } finally {
            // åœæ­¢åŠ è½½åŠ¨ç”»
            if (refreshIcon) {
              setTimeout(() => {
                refreshIcon.classList.remove('weather-update__icon--loading');
              }, 500);
            }
          }
        },
        
        // åˆå§‹åŒ–
        init() {
          // é¦–æ¬¡åŠ è½½
          this.refreshWeather();
          
          // æ¸²æŸ“å†å²è®°å½•ï¼ˆåŒ…å« 7 å¤©æœ€ä½/æœ€é«˜æ¸©å’Œå¤©æ°”æƒ…å†µï¼‰
          this.renderHistory();
          
          // æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
          const refreshBtn = document.getElementById('refreshBtn');
          if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
              this.refreshWeather();
            });
          }
          
          // æ¯å°æ—¶è‡ªåŠ¨åˆ·æ–°ï¼ˆ3600000æ¯«ç§’ = 1å°æ—¶ï¼‰
          setInterval(() => this.refreshWeather(), 3600000);
        }
      };
      
      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', () => {
        WeatherManager.init();
      });
    </script>
  </body>
</html>

