<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å•†å“è¯¦æƒ… Â· çŸ³åˆ»æŠ¤æŸ </title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .product-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin: 30px 0;
      }
      /* å•†å“å›¾ç‰‡ç”»å»Šï¼ˆå·¦ä¾§ç¼©ç•¥å›¾ + å³ä¾§å¤§å›¾ï¼‰ */
      .product-gallery {
        background: #f8f8f8;
        border-radius: 12px;
        padding: 16px;
        display: grid;
        grid-template-columns: 92px 1fr;
        gap: 14px;
        min-height: 420px;
        align-items: stretch;
      }
      .product-thumbs {
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow: auto;
        padding-right: 4px;
      }
      .product-thumb {
        width: 84px;
        height: 84px;
        padding: 0;
        border-radius: 10px;
        border: 1px solid rgba(160, 140, 90, 0.25);
        background: rgba(255,255,255,0.7);
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        appearance: none;
        -webkit-appearance: none;
        outline: none;
      }
      .product-thumb:hover {
        transform: translateY(-1px);
        border-color: rgba(200, 176, 106, 0.6);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      .product-thumb.active {
        border-color: rgba(200, 176, 106, 0.9);
        box-shadow: 0 0 0 3px rgba(200, 176, 106, 0.18);
      }
      .product-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .product-main {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        background: rgba(255,255,255,0.85);
        border: 1px solid rgba(160, 140, 90, 0.12);
        overflow: hidden;
      }
      .product-main img {
        width: 100%;
        height: 100%;
        max-height: 520px;
        /* å…³é”®ï¼šé“ºæ»¡å®¹å™¨ï¼Œä¸ç•™å·¦å³ç™½è¾¹ï¼ˆå¿…è¦æ—¶ä¼šè£åˆ‡ï¼‰ */
        object-fit: cover;
        display: block;
      }
      .product-info {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .product-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--ink);
        margin: 0;
      }
      .product-price {
        font-size: 32px;
        font-weight: 700;
        color: var(--accent);
        margin: 0;
      }
      /* å·²ç§»é™¤â€œå•†å“è§„æ ¼èƒ¶å›Šâ€å±•ç¤ºï¼šè§„æ ¼ç»Ÿä¸€ä½¿ç”¨ä¸‹æ–¹ sku åˆ—è¡¨ */
      /* è§„æ ¼åˆ—è¡¨ï¼ˆä»¿æ·˜å®å³ä¾§è§„æ ¼è¡Œï¼‰ */
      .sku-list {
        background: transparent;
        border: none;
        padding: 10px 0;
        display: flex;
        flex-direction: column;
        gap: 0;
        box-shadow: none;
        transition: none;
      }
      .sku-list:hover {
        box-shadow: none;
      }
      .sku-list__title {
        display: none; /* å›¾ä¸€é£æ ¼ä¸éœ€è¦æ˜¾å¼çš„â€œè§„æ ¼é€‰æ‹©â€å¤§æ ‡é¢˜ï¼Œæˆ–è€…å¯ä»¥ä¿ç•™ä½†æ ·å¼ç®€åŒ– */
      }
      .sku-items {
        display: flex;
        flex-direction: column;
        gap: 14px;
        max-height: 480px;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 8px;
        padding-bottom: 4px;
      }
      /* ç¾åŒ–æ»šåŠ¨æ¡ */
      .sku-items::-webkit-scrollbar {
        width: 8px;
      }
      .sku-items::-webkit-scrollbar-track {
        background: rgba(247, 243, 234, 0.5);
        border-radius: 10px;
      }
      .sku-items::-webkit-scrollbar-thumb {
        background: rgba(200, 176, 106, 0.4);
        border-radius: 10px;
        transition: background 0.2s ease;
      }
      .sku-items::-webkit-scrollbar-thumb:hover {
        background: rgba(200, 176, 106, 0.6);
      }
      /* æ¯ä¸€ç»„è§„æ ¼ï¼šå·¦ä¾§æ˜¯â€œé¢œè‰²/æ€»é‡â€ç­‰æ ‡ç­¾ï¼Œå³ä¾§æ˜¯å…·ä½“é€‰é¡¹æŒ‰é’® */
      .sku-group {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 0;
        margin-bottom: 16px;
        background: transparent;
        border: none;
      }
      .sku-group:hover {
        background: transparent;
        border-color: transparent;
      }
      .sku-group__label {
        flex: 0 0 40px;
        font-size: 14px;
        font-weight: 500;
        color: var(--muted);
        padding-top: 0;
        white-space: nowrap;
        text-align: left;
        font-family: system-ui, -apple-system, sans-serif;
      }
      .sku-group__body {
        flex: 1;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 12px;
      }
      /* ç®€å•è§„æ ¼ï¼ˆæˆ‘ä»¬åœ¨åå°å½•å…¥çš„ specsï¼‰å±•ç¤ºä¸ºç´§å‡‘æŒ‰é’®ï¼Œç±»ä¼¼å›¾ä¸€ */
      .sku-item--simple {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        padding: 8px 20px;
        background: #fff;
        border: 1px solid #e0e0e0;
        cursor: pointer;
        transition: all 0.2s ease;
        min-height: 38px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        font-family: system-ui, -apple-system, sans-serif; /* UI Font */
      }
      .sku-item--simple:hover {
        border-color: var(--accent);
        color: var(--accent);
        background: rgba(255,255,255,0.8);
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(200, 176, 106, 0.15);
      }
      .sku-item--simple .sku-item__left {
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }
      .sku-item__thumb {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        overflow: hidden;
        background: #f0f0f0;
        flex-shrink: 0;
        border: 1px solid rgba(0,0,0,0.05);
      }
      .sku-item__thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .sku-item__texts {
        display: flex;
        flex-direction: column;
        gap: 0;
      }
      .sku-item--simple .sku-item__name {
        color: var(--ink);
        font-size: 14px;
        font-weight: 400;
      }
      .sku-item--simple.active .sku-item__name {
        color: #fff;
        font-weight: 500;
      }
      .sku-item--simple .sku-item__sub {
        display: none; /* éšè—å†—ä½™çš„å‰¯æ ‡é¢˜ */
      }
      .sku-item--simple.active {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border-color: transparent;
        color: #fff;
        box-shadow: 0 4px 10px rgba(200, 176, 106, 0.3);
        transform: translateY(-1px);
      }
      /* ç§»é™¤æ—§çš„ flex column æ ·å¼å½±å“ */
      .sku-item {
        margin: 0;
      }
      .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
      }
      /* è¯¦æƒ…é¡µæ”¶è—æŒ‰é’®æ ·å¼ */
      #favorite-btn.product__fav {
        position: static;
        margin: 0;
      }
      .btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 999px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        letter-spacing: 1px;
        font-family: system-ui, -apple-system, sans-serif;
      }
      .btn-primary {
        background: linear-gradient(135deg, #d4c07b, #b6984f);
        color: white;
        box-shadow: 0 8px 20px -4px rgba(182, 152, 64, 0.5);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px -6px rgba(182, 152, 64, 0.6);
      }
      .btn-secondary {
        background: #fff;
        color: #b6984f;
        border: 1px solid #e0d6c0;
      }
      .btn-secondary:hover {
        background: #faf8f2;
        border-color: #b6984f;
        color: #9d8750;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px -6px rgba(0,0,0,0.08);
      }
      /* æ ‡ç­¾é¡µæ ·å¼ */
      .product-tabs {
        margin-top: 40px;
        display: flex;
        gap: 0;
        border-bottom: 2px solid rgba(160, 140, 90, 0.2);
      }
      .product-tab {
        padding: 16px 24px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        font-size: 16px;
        font-weight: 500;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        bottom: -2px;
      }
      .product-tab:hover {
        color: var(--accent2);
      }
      .product-tab.active {
        color: var(--accent2);
        border-bottom-color: var(--accent);
        font-weight: 600;
      }
      .product-tab-content {
        display: none;
        margin-top: 24px;
      }
      .product-tab-content.active {
        display: block;
      }
      
      .product-description {
        padding: 20px;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      }
      .description-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--ink);
        margin: 0 0 20px 0;
      }
      .description-content {
        font-size: 14px;
        line-height: 1.6;
        color: var(--muted);
      }
      
      /* è¯„è®ºåŒºæ ·å¼ */
      .comment-section {
        padding: 20px;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      }
      .comment-form {
        margin-bottom: 32px;
        padding: 20px;
        background: rgba(247, 243, 234, 0.5);
        border-radius: 12px;
        border: 1px solid rgba(200, 176, 106, 0.2);
      }
      .comment-form__title {
        font-size: 16px;
        font-weight: 600;
        color: var(--ink);
        margin: 0 0 16px 0;
      }
      .comment-form__rating {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }
      .comment-form__rating-label {
        font-size: 14px;
        color: var(--ink);
      }
      .comment-form__stars {
        display: flex;
        gap: 4px;
      }
      .comment-form__star {
        font-size: 24px;
        color: #ddd;
        cursor: pointer;
        transition: all 0.2s ease;
        line-height: 1;
      }
      .comment-form__star:hover,
      .comment-form__star.active {
        color: #ffc107;
      }
      .comment-form__input {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 1px solid rgba(160, 140, 90, 0.3);
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        margin-bottom: 12px;
        transition: all 0.3s ease;
      }
      .comment-form__input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(200, 176, 106, 0.1);
      }
      .comment-form__submit {
        padding: 10px 24px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .comment-form__submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(200, 176, 106, 0.3);
      }
      .comment-form__submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .comment-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .comment-item {
        padding: 20px;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(160, 140, 90, 0.15);
        border-radius: 12px;
        transition: all 0.3s ease;
      }
      .comment-item:hover {
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      .comment-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .comment-user {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
      }
      .comment-user-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .comment-username {
        font-size: 14px;
        font-weight: 600;
        color: var(--ink);
      }
      .comment-rating {
        display: flex;
        gap: 2px;
      }
      .comment-rating-star {
        font-size: 14px;
        color: #ffc107;
      }
      .comment-date {
        font-size: 12px;
        color: var(--muted);
      }
      .comment-content {
        font-size: 14px;
        line-height: 1.6;
        color: var(--ink);
        margin-bottom: 12px;
      }
      .comment-actions {
        display: flex;
        gap: 16px;
        padding-top: 12px;
        border-top: 1px solid rgba(160, 140, 90, 0.1);
      }
      .comment-action {
        font-size: 12px;
        color: var(--muted);
        cursor: pointer;
        transition: color 0.2s ease;
      }
      .comment-action:hover {
        color: var(--accent2);
      }
      .comment-empty {
        text-align: center;
        padding: 60px 20px;
        color: var(--muted);
      }
      .comment-empty__icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      .comment-empty__text {
        font-size: 14px;
      }

      @media (max-width: 980px) {
        .product-container {
          grid-template-columns: 1fr;
        }
        .product-gallery {
          grid-template-columns: 1fr;
        }
        .product-thumbs {
          flex-direction: row;
          padding-right: 0;
          padding-bottom: 4px;
        }
        .product-thumb {
          width: 76px;
          height: 76px;
          flex: 0 0 auto;
        }
      }
      
      /* å•†å“è¯¦æƒ…è¡¨æ ¼æ ·å¼ */
      .detail-attributes-table {
        margin-bottom: 24px;
        border: 1px solid rgba(0,0,0,0.06);
        border-radius: 8px;
        overflow: hidden;
        font-size: 14px;
      }
      .detail-attribute-row {
        display: flex;
        border-bottom: 1px solid rgba(0,0,0,0.06);
      }
      .detail-attribute-row:last-child {
        border-bottom: none;
      }
      .detail-attribute-name {
        width: 120px;
        padding: 12px 16px;
        font-weight: 500;
        color: var(--muted);
        background: rgba(250, 246, 236, 0.5);
        border-right: 1px solid rgba(0,0,0,0.06);
        display: flex;
        align-items: center;
      }
      .detail-attribute-value {
        flex: 1;
        padding: 12px 16px;
        color: var(--ink);
        background: #fff;
      }
      .detail-images img {
        width: 100%;
        display: block;
        margin-bottom: 0;
        border-radius: 0;
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar__inner">
        <a class="brand" href="index.html" aria-label="è¿”å›å•†å“é¡µ">
          <img class="brand__logo" src="assets/logo.png" alt="çŸ³åˆ»æŠ¤æŸ  Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
          <span class="brand__text" style="display:none;">çŸ³åˆ»æŠ¤æŸ </span>
        </a>

        <nav class="nav">
          <a class="nav__item" href="weather.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M7.5 18.5h10.2a4.3 4.3 0 0 0 .5-8.6A6.2 6.2 0 0 0 6.1 8.4 4.4 4.4 0 0 0 7.5 18.5Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            å¤©æ°”
          </a>
          <a class="nav__item" href="index.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M7.5 8.2V7a4.5 4.5 0 0 1 9 0v1.2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M6.3 8.2h11.4l1 12.5H5.3l1-12.5Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
            </span>
            å•†å“
          </a>
          <a class="nav__item" href="activate.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M6.6 4.8h9.7a2.2 2.2 0 0 1 2.2 2.2v12.2a2.2 2.2 0 0 0-2.2-2.2H6.6a2.2 2.2 0 0 0-2.2 2.2V7a2.2 2.2 0 0 1 2.2-2.2Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M8.2 7.6h7.1M8.2 10.4h7.1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            </span>
            æ´»åŠ¨
          </a>
          <a class="nav__item" href="store.html">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="9" r="2.5" stroke="currentColor" stroke-width="1.6"/></svg>
            </span>
            é—¨åº—
          </a>
        </nav>

        <div class="topbar__right">
          <a class="toplink" href="favorites.html">æˆ‘çš„æ”¶è—</a>
          <div class="topbar__auth" id="authArea">
            <a class="toplink" href="login.html" id="authLink">ç™»å½•æ³¨å†Œ</a>
          </div>
        </div>
      </div>
      <div class="topbar__divider"></div>
    </header>

    <main class="page">
      <section class="container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <a href="javascript:void(0)" onclick="history.back(); return false;" style="color: var(--accent2); text-decoration: none; cursor: pointer;">&lt; è¿”å›</a>
            <a href="index.html" style="color: var(--accent2); text-decoration: none;">é¦–é¡µ</a>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button id="favorite-btn" class="product__fav" type="button" aria-label="æ”¶è—" aria-pressed="false">
              <span class="star-icon">â˜†</span>
              <span class="favorite-text">æ”¶è—</span>
            </button>
          </div>
        </div>

        <div class="product-container">
          <div class="product-gallery" aria-label="å•†å“å›¾ç‰‡">
            <div class="product-thumbs" id="productThumbs" aria-label="ç¼©ç•¥å›¾åˆ—è¡¨"></div>
            <div class="product-main">
              <img id="productMainImg" src="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=fresh%20lemon%20fruit%20on%20white%20background&image_size=square" alt="å•†å“å›¾ç‰‡" />
            </div>
          </div>
          <div class="product-info">
            <h1 class="product-title">å®‰å²³æ–°é²œæŸ æª¬</h1>
            <p class="product-price">Â¥19.90</p>
            
        <!-- å·²ç§»é™¤â€œå•†å“è§„æ ¼/æ ‡å‡†è§„æ ¼â€èƒ¶å›ŠåŒºåŸŸï¼šè§„æ ¼ç»Ÿä¸€ä½¿ç”¨ä¸‹æ–¹â€œè§„æ ¼é€‰æ‹©â€åˆ—è¡¨ -->

            <!-- è§„æ ¼åˆ—è¡¨ï¼ˆæ›¿ä»£â€œå–å®¶ä¿¡æ¯â€ï¼‰ -->
            <div class="sku-list" id="skuList" aria-label="è§„æ ¼åˆ—è¡¨" hidden>
              <div class="sku-list__title">è§„æ ¼é€‰æ‹©</div>
              <div class="sku-list__group-name" id="skuGroupName" style="font-size:13px;color:var(--muted);margin-bottom:6px;"></div>
              <div class="sku-items" id="skuItems"></div>
            </div>

            <div class="action-buttons">
              <button class="btn btn-secondary">è”ç³»å®¢æœ</button>
            <button class="btn btn-primary">ç«‹å³è´­ä¹°</button>
            </div>
          </div>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="product-tabs">
          <button class="product-tab active" data-tab="details">å•†å“è¯¦æƒ…</button>
          <button class="product-tab" data-tab="comments">è¯„è®º</button>
        </div>

        <!-- å•†å“è¯¦æƒ…å†…å®¹ -->
        <div class="product-tab-content active" id="detailsContent">
          <div class="product-description">
            <h2 class="description-title">å•†å“è¯¦æƒ…</h2>
            <div class="description-content">
              <!-- åŠ¨æ€åŠ è½½å†…å®¹ -->
            </div>
          </div>
        </div>

        <!-- è¯„è®ºå†…å®¹ -->
        <div class="product-tab-content" id="commentsContent">
          <div class="comment-section">
            <!-- è¯„è®ºè¡¨å• -->
            <div class="comment-form">
              <h3 class="comment-form__title">å‘è¡¨è¯„è®º</h3>
              <div class="comment-form__rating">
                <span class="comment-form__rating-label">è¯„åˆ†ï¼š</span>
                <div class="comment-form__stars" id="ratingStars">
                  <span class="comment-form__star" data-rating="1">â˜†</span>
                  <span class="comment-form__star" data-rating="2">â˜†</span>
                  <span class="comment-form__star" data-rating="3">â˜†</span>
                  <span class="comment-form__star" data-rating="4">â˜†</span>
                  <span class="comment-form__star" data-rating="5">â˜†</span>
                </div>
                <span id="ratingText" style="font-size: 13px; color: var(--muted); margin-left: 8px;">è¯·é€‰æ‹©è¯„åˆ†</span>
              </div>
              <textarea 
                class="comment-form__input" 
                id="commentInput" 
                placeholder="å†™ä¸‹æ‚¨çš„è´­ä¹°ä½“éªŒå’Œä½¿ç”¨æ„Ÿå—..."
                maxlength="500"></textarea>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 12px; color: var(--muted);">
                  <span id="charCount">0</span>/500
                </span>
                <button class="comment-form__submit" id="submitComment">å‘è¡¨è¯„è®º</button>
              </div>
            </div>

            <!-- è¯„è®ºåˆ—è¡¨ -->
            <div class="comment-list" id="commentList">
              <!-- è¯„è®ºå°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </div>
          </div>
        </div>
      </section>
    </main>

    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
      function escapeHtml(str) {
        if (str == null) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // å·²ç§»é™¤â€œå•†å“è§„æ ¼èƒ¶å›Šâ€å±•ç¤ºï¼šè§„æ ¼ç»Ÿä¸€ä½¿ç”¨ä¸‹æ–¹ sku åˆ—è¡¨

      // è´­ä¹°æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - è·³è½¬åˆ°æ·˜å®å•†å“é¡µé¢
      document.querySelector('.btn-primary').addEventListener('click', function() {
        // è·å–å½“å‰å•†å“ID
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id') || 'fresh-1';
        
        // ä»å•†å“æ•°æ®ä¸­è·å–æ·˜å®é“¾æ¥
        const products = window.PRODUCTS || [];
        const product = products.find(p => p.id === productId);
        
        if (product && product.taobaoUrl) {
          // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æ·˜å®é“¾æ¥
          window.open(product.taobaoUrl, '_blank');
        } else {
          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”å•†å“ï¼Œè·³è½¬åˆ°æ·˜å®æœç´¢é¡µé¢
          const title = document.querySelector('.product-title')?.textContent || 'å®‰å²³æŸ æª¬';
          window.open(`https://s.taobao.com/search?q=${encodeURIComponent(title)}`, '_blank');
        }
      });

      // è”ç³»å®¢æœï¼šå¸¦ä¸Šå½“å‰å•†å“ä¿¡æ¯ï¼Œå®¢æœé¡µä¼šåˆ·æ–°ä¸ºè¯¥å•†å“å¹¶å¯é€‰æ‹©å‘é€ç»™å®¢æœ
      document.querySelector('.btn-secondary').addEventListener('click', function() {
        const titleEl = document.querySelector('.product-title');
        const priceEl = document.querySelector('.product-price');
        const imgEl = document.getElementById('productMainImg');
        const id = urlParams.get('id') || 'fresh-1';
        const title = (titleEl && titleEl.textContent) ? titleEl.textContent.trim() : 'å®‰å²³æ–°é²œæŸ æª¬';
        const price = (priceEl && priceEl.textContent) ? priceEl.textContent.trim() : 'Â¥19.90';
        const image = (imgEl && imgEl.src) ? imgEl.src : '';
        const q = new URLSearchParams({ id: id, title: title, price: price });
        // ç”¨æ—¶é—´æˆ³æ ‡è¯†ä¸€æ¬¡â€œå‘èµ·å’¨è¯¢â€ï¼Œé¿å…å®¢æœé¡µåˆ·æ–°é‡å¤å‘é€
        q.set('ts', String(Date.now()));
        if (image) q.set('image', image);
        window.location.href = 'customer_service.html?' + q.toString();
      });

      // è·å–å½“å‰å•†å“ID
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id') || 'fresh-1';

      // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
      document.querySelectorAll('.product-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const targetTab = this.dataset.tab;
          
          // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
          document.querySelectorAll('.product-tab').forEach(t => {
            t.classList.remove('active');
          });
          this.classList.add('active');
          
          // æ›´æ–°å†…å®¹æ˜¾ç¤º
          document.querySelectorAll('.product-tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(targetTab + 'Content').classList.add('active');
        });
      });

      // è¯„è®ºåŠŸèƒ½
      const CommentManager = {
        // è·å–è¯„è®ºå­˜å‚¨key
        getStorageKey() {
          return `anyue_lemon:comments:${productId}`;
        },
        
        // è·å–è¯„è®ºåˆ—è¡¨
        getComments() {
          try {
            const raw = localStorage.getItem(this.getStorageKey());
            return raw ? JSON.parse(raw) : [];
          } catch {
            return [];
          }
        },
        
        // ä¿å­˜è¯„è®ºåˆ—è¡¨
        saveComments(comments) {
          localStorage.setItem(this.getStorageKey(), JSON.stringify(comments));
        },
        
        // æ·»åŠ è¯„è®º
        addComment(rating, content) {
          const comments = this.getComments();
          const user = JSON.parse(localStorage.getItem('user') || '{"name":"åŒ¿åç”¨æˆ·"}');
          const username = user.name || user.phone || 'åŒ¿åç”¨æˆ·';
          
          const newComment = {
            id: Date.now(),
            username: username,
            rating: rating,
            content: content,
            date: new Date().toISOString(),
            likes: 0
          };
          
          comments.unshift(newComment); // æœ€æ–°è¯„è®ºåœ¨å‰
          this.saveComments(comments);
          return newComment;
        },
        
        // åˆ é™¤è¯„è®º
        deleteComment(commentId) {
          const comments = this.getComments();
          const filtered = comments.filter(c => c.id !== commentId);
          this.saveComments(filtered);
        },
        
        // ç‚¹èµè¯„è®º
        likeComment(commentId) {
          const comments = this.getComments();
          const comment = comments.find(c => c.id === commentId);
          if (comment) {
            comment.likes = (comment.likes || 0) + 1;
            this.saveComments(comments);
          }
        },
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        formatDate(dateString) {
          const date = new Date(dateString);
          const now = new Date();
          const diff = now - date;
          const minutes = Math.floor(diff / 60000);
          const hours = Math.floor(diff / 3600000);
          const days = Math.floor(diff / 86400000);
          
          if (minutes < 1) return 'åˆšåˆš';
          if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
          if (hours < 24) return `${hours}å°æ—¶å‰`;
          if (days < 7) return `${days}å¤©å‰`;
          
          return date.toLocaleDateString('zh-CN', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit' 
          });
        },
        
        // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
        renderComments() {
          const commentList = document.getElementById('commentList');
          const comments = this.getComments();
          
          if (comments.length === 0) {
            commentList.innerHTML = `
              <div class="comment-empty">
                <div class="comment-empty__icon">ğŸ’¬</div>
                <div class="comment-empty__text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</div>
              </div>
            `;
            return;
          }
          
          commentList.innerHTML = comments.map(comment => {
            const stars = 'â˜…'.repeat(comment.rating) + 'â˜†'.repeat(5 - comment.rating);
            const firstChar = comment.username.charAt(0).toUpperCase();
            
            return `
              <div class="comment-item" data-id="${comment.id}">
                <div class="comment-header">
                  <div class="comment-user">
                    <div class="comment-avatar">${firstChar}</div>
                    <div class="comment-user-info">
                      <div class="comment-username">${comment.username}</div>
                      <div class="comment-rating">
                        ${stars.split('').map((star, i) => 
                          `<span class="comment-rating-star">${star}</span>`
                        ).join('')}
                      </div>
                    </div>
                  </div>
                  <div class="comment-date">${this.formatDate(comment.date)}</div>
                </div>
                <div class="comment-content">${comment.content}</div>
                <div class="comment-actions">
                  <span class="comment-action" onclick="CommentManager.likeComment(${comment.id}); CommentManager.renderComments();">
                    ğŸ‘ æœ‰ç”¨ (${comment.likes || 0})
                  </span>
                  ${comment.username === (JSON.parse(localStorage.getItem('user') || '{}').name || '') ? 
                    `<span class="comment-action" onclick="if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) { CommentManager.deleteComment(${comment.id}); CommentManager.renderComments(); }" style="color: #f44336;">åˆ é™¤</span>` : 
                    ''}
                </div>
              </div>
            `;
          }).join('');
        },
        
        // åˆå§‹åŒ–
        init() {
          // è¯„åˆ†æ˜Ÿæ˜Ÿäº¤äº’
          let selectedRating = 0;
          const stars = document.querySelectorAll('.comment-form__star');
          const ratingText = document.getElementById('ratingText');
          const ratingTexts = ['', 'å¾ˆå·®', 'è¾ƒå·®', 'ä¸€èˆ¬', 'è¾ƒå¥½', 'å¾ˆå¥½'];
          
          stars.forEach((star, index) => {
            star.addEventListener('mouseenter', function() {
              const rating = parseInt(this.dataset.rating);
              stars.forEach((s, i) => {
                s.textContent = i < rating ? 'â˜…' : 'â˜†';
                s.classList.toggle('active', i < rating);
              });
              ratingText.textContent = ratingTexts[rating] || '';
            });
            
            star.addEventListener('click', function() {
              selectedRating = parseInt(this.dataset.rating);
              stars.forEach((s, i) => {
                s.textContent = i < selectedRating ? 'â˜…' : 'â˜†';
                s.classList.toggle('active', i < selectedRating);
              });
              ratingText.textContent = ratingTexts[selectedRating] || '';
            });
          });
          
          document.querySelector('.comment-form__stars').addEventListener('mouseleave', function() {
            stars.forEach((s, i) => {
              s.textContent = i < selectedRating ? 'â˜…' : 'â˜†';
              s.classList.toggle('active', i < selectedRating);
            });
            ratingText.textContent = selectedRating > 0 ? ratingTexts[selectedRating] : 'è¯·é€‰æ‹©è¯„åˆ†';
          });
          
          // å­—ç¬¦è®¡æ•°
          const commentInput = document.getElementById('commentInput');
          const charCount = document.getElementById('charCount');
          commentInput.addEventListener('input', function() {
            charCount.textContent = this.value.length;
          });
          
          // æäº¤è¯„è®º
          document.getElementById('submitComment').addEventListener('click', function() {
            const content = commentInput.value.trim();
            
            if (selectedRating === 0) {
              alert('è¯·å…ˆé€‰æ‹©è¯„åˆ†ï¼');
              return;
            }
            
            if (!content) {
              alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹ï¼');
              return;
            }
            
            if (content.length < 5) {
              alert('è¯„è®ºå†…å®¹è‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦ï¼');
              return;
            }
            
            // æ·»åŠ è¯„è®º
            CommentManager.addComment(selectedRating, content);
            
            // é‡ç½®è¡¨å•
            commentInput.value = '';
            charCount.textContent = '0';
            selectedRating = 0;
            stars.forEach(s => {
              s.textContent = 'â˜†';
              s.classList.remove('active');
            });
            ratingText.textContent = 'è¯·é€‰æ‹©è¯„åˆ†';
            
            // é‡æ–°æ¸²æŸ“è¯„è®ºåˆ—è¡¨
            CommentManager.renderComments();
            
            alert('è¯„è®ºå‘è¡¨æˆåŠŸï¼');
          });
          
          // åˆå§‹æ¸²æŸ“è¯„è®ºåˆ—è¡¨
          this.renderComments();
        }
      };
      
      // æ”¶è—æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨ç»Ÿä¸€çš„æ”¶è—é€»è¾‘
      const favoriteBtn = document.getElementById('favorite-btn');
      if (favoriteBtn) {
        function checkFavoriteStatus() {
          try {
            const storageKey = (window.STORAGE_KEYS && window.STORAGE_KEYS.favorites) || "anyue_lemon:favorites";
            const raw = localStorage.getItem(storageKey);
            const favs = new Set(raw ? JSON.parse(raw) : []);
            const isFavorite = favs.has(productId);
            favoriteBtn.setAttribute('aria-pressed', String(isFavorite));
            updateFavoriteButton(isFavorite);
          } catch {
            favoriteBtn.setAttribute('aria-pressed', 'false');
            updateFavoriteButton(false);
          }
        }
        
        function updateFavoriteButton(isFavorite) {
          const starIcon = favoriteBtn.querySelector('.star-icon');
          const favoriteText = favoriteBtn.querySelector('.favorite-text');
          if (starIcon) {
            starIcon.textContent = isFavorite ? 'â˜…' : 'â˜†';
          }
          if (favoriteText) {
            favoriteText.textContent = isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—';
          }
        }
        
        favoriteBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          try {
            const storageKey = (window.STORAGE_KEYS && window.STORAGE_KEYS.favorites) || "anyue_lemon:favorites";
            const raw = localStorage.getItem(storageKey);
            const favs = new Set(raw ? JSON.parse(raw) : []);
            const currentState = favoriteBtn.getAttribute('aria-pressed') === 'true';
            const nextState = !currentState;
            
            favoriteBtn.setAttribute('aria-pressed', String(nextState));
            updateFavoriteButton(nextState);
            
            if (nextState) {
              favs.add(productId);
              // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é¡µé¢æ›´æ–°
              window.dispatchEvent(new CustomEvent('favoritesUpdated', { detail: { productId: productId, action: 'add' } }));
            } else {
              favs.delete(productId);
              // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é¡µé¢æ›´æ–°
              window.dispatchEvent(new CustomEvent('favoritesUpdated', { detail: { productId: productId, action: 'remove' } }));
            }
            
            localStorage.setItem(storageKey, JSON.stringify([...favs]));
          } catch (error) {
            console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
            alert('æ”¶è—æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
          }
        });
        
        // åˆå§‹åŒ–æ£€æŸ¥
        checkFavoriteStatus();
      }
      
      // åˆå§‹åŒ–è¯„è®ºåŠŸèƒ½
      CommentManager.init();

      // ä»åç«¯æˆ–æœ¬åœ°æ•°æ®åŠ è½½å•†å“è¯¦æƒ…å’Œè§„æ ¼
      function applyProductToPage(p) {
        if (!p) return;
        const titleEl = document.querySelector('.product-title');
        const priceEl = document.querySelector('.product-price');
        const mainImgEl = document.getElementById('productMainImg');
        const thumbsEl = document.getElementById('productThumbs');
        const descEl = document.querySelector('.description-content');
        if (titleEl) titleEl.textContent = p.title || '';
        if (priceEl) {
          const fmt = window.formatPrice || function(n) { return 'Â¥' + Number(n).toFixed(1); };
          priceEl.textContent = fmt(p.price ?? 0);
        }
        function normalizeImageList(x) {
          const out = [];
          if (Array.isArray(x)) {
            x.forEach((u) => {
              if (u) out.push(String(u).trim());
            });
          } else if (typeof x === 'string' && x.trim()) {
            x.split(/\r?\n|,/).forEach((u) => {
              if (u && String(u).trim()) out.push(String(u).trim());
            });
          }
          if (p.img) out.unshift(String(p.img).trim());
          return [...new Set(out.filter(Boolean))];
        }

        function renderGallery(urls, activeUrl) {
          if (!mainImgEl) return;
          const list = (urls && urls.length) ? urls : (p.img ? [p.img] : []);
          const active = activeUrl || list[0] || '';
          if (active) mainImgEl.src = active;
          if (!thumbsEl) return;

          thumbsEl.innerHTML = list
            .map((url) => {
              const isActive = url === active;
              return `
                <button class="product-thumb${isActive ? ' active' : ''}" type="button" data-url="${escapeHtml(url)}" aria-label="åˆ‡æ¢å›¾ç‰‡">
                  <img src="${escapeHtml(url)}" alt="å•†å“ç¼©ç•¥å›¾" loading="lazy" />
                </button>
              `;
            })
            .join('');

          thumbsEl.querySelectorAll('.product-thumb').forEach((btn) => {
            btn.addEventListener('click', () => {
              const url = btn.getAttribute('data-url') || '';
              if (url) {
                mainImgEl.src = url;
                thumbsEl.querySelectorAll('.product-thumb').forEach((b) => b.classList.remove('active'));
                btn.classList.add('active');
              }
            });
          });
        }

        renderGallery(normalizeImageList(p.images), p.img || '');
        
        // æ¸²æŸ“è¯¦æƒ… Tab å†…å®¹ (å±æ€§è¡¨æ ¼ + æ–‡å­—æè¿° + æµ·æŠ¥)
        if (descEl) {
            let html = '';
            
            // 1. å±æ€§è¡¨æ ¼
            if (p.detailAttributes && Array.isArray(p.detailAttributes) && p.detailAttributes.length > 0) {
              html += `<div class="detail-attributes-table">`;
              p.detailAttributes.forEach(attr => {
                html += `
                  <div class="detail-attribute-row">
                    <div class="detail-attribute-name">${escapeHtml(attr.name)}</div>
                    <div class="detail-attribute-value">${escapeHtml(attr.value)}</div>
                  </div>
                `;
              });
              html += `</div>`;
            }

            // 2. æ–‡å­—æè¿° - å·²ç¦ç”¨
            /*
            if (p.desc || p.description || p.detail) {
               const text = p.desc || p.description || p.detail || '';
               // å¦‚æœæ²¡æœ‰å±æ€§å’Œå›¾ç‰‡ï¼Œä¿æŒåŸæœ‰ç®€å•çš„æ®µè½åˆ†å‰²é€»è¾‘
               if ((!p.detailAttributes || p.detailAttributes.length === 0) && (!p.detailImages || p.detailImages.length === 0)) {
                   const paragraphs = String(text).split(/\n{2,}|\r?\n/).filter(Boolean);
                   html += paragraphs.map(t => `<p>${t}</p>`).join('');
               } else {
                   // å¦åˆ™ä½œä¸ºè¯¦æƒ…çš„ä¸€éƒ¨åˆ†
                   html += `<div class="description-text" style="margin-bottom:24px;line-height:1.8;">${escapeHtml(text)}</div>`;
               }
            }
            */

            // 3. è¯¦æƒ…æµ·æŠ¥
            if (p.detailImages && Array.isArray(p.detailImages) && p.detailImages.length > 0) {
              html += `<div class="detail-images">`;
              p.detailImages.forEach(url => {
                html += `<img src="${url}" alt="è¯¦æƒ…æµ·æŠ¥" loading="lazy" />`;
              });
              html += `</div>`;
            }
            
            if (html) {
                descEl.innerHTML = html;
                // é‡ç½®å®¹å™¨æ ·å¼ä»¥é€‚åº”å…¨å®½å›¾ç‰‡å’Œè¡¨æ ¼
                descEl.style.padding = '0';
                descEl.style.background = 'transparent';
                descEl.style.boxShadow = 'none';
            }
        }

        // æ–°ç»“æ„ï¼šattributes = [{groupId,name,values:[{id,value}]}] + skus = [{id,price,stock,img,values:[{valueId,groupId,...}]}]
        const attributes = p.attributes || [];
        const skus = p.skus || [];
        let simpleSpecs = p.specs || [];

        // å¦‚æœæ²¡æœ‰ specs æ•°æ®ä½†æœ‰ skus æ•°æ®ï¼ˆä¸” skus åŒ…å« values ç»“æ„ï¼‰ï¼Œå°è¯•ä» skus åæ¨ specs
        // è¿™æ ·å¯ä»¥ç¡®ä¿å³ä½¿æ•°æ®ç¼ºå¤±ï¼Œä¹Ÿèƒ½å±•ç¤ºä¸ºâ€œè§„æ ¼åˆ†ç»„â€æ ·å¼ï¼ˆå›¾äºŒæ ·å¼ï¼‰ï¼Œè€Œä¸æ˜¯å›é€€åˆ°é•¿åˆ—è¡¨ï¼ˆå›¾ä¸€æ ·å¼ï¼‰
        if ((!simpleSpecs || simpleSpecs.length === 0) && skus.length > 0) {
          const groupMap = new Map(); // groupName -> Set(values)
          // åŒæ—¶ä¹Ÿæ”¶é›†å›¾ç‰‡ï¼švalue -> imgUrl (å¦‚æœ SKU åˆšå¥½æ˜¯å•è§„æ ¼æˆ–è€…æˆ‘ä»¬èƒ½æ¨æ–­å‡ºå›¾ç‰‡)
          // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šåªæ”¶é›†æ–‡æœ¬å€¼
          skus.forEach(sku => {
             if (sku.values && Array.isArray(sku.values)) {
               sku.values.forEach(v => {
                 const gName = v.groupName;
                 const val = v.value;
                 if (gName && val) {
                   if (!groupMap.has(gName)) {
                     groupMap.set(gName, new Set());
                   }
                   groupMap.get(gName).add(val);
                 }
               });
             }
          });
          
          if (groupMap.size > 0) {
            simpleSpecs = [];
            groupMap.forEach((valSet, gName) => {
              const values = Array.from(valSet).map(v => ({ value: v }));
              simpleSpecs.push({ name: gName, values: values });
            });
          }
        }

        // æ¸²æŸ“â€œè§„æ ¼åˆ—è¡¨â€ï¼ˆä»¿æ·˜å®å³ä¾§åˆ—è¡¨ï¼‰
        const skuListEl = document.getElementById('skuList');
        const skuItemsEl = document.getElementById('skuItems');

        // ä¼˜å…ˆä½¿ç”¨ simpleSpecs æ¸²æŸ“UIï¼Œå› ä¸ºæˆ‘ä»¬åªç»´æŠ¤äº† simpleSpecs å’Œ flat skus
        // å¦‚æœåç«¯è¿˜æ²¡æœ‰æ­£å¼ sku ç»“æ„ï¼Œä½†æœ‰æˆ‘ä»¬åœ¨åå°å½•å…¥çš„ç®€å• specsï¼Œå°±ç”¨ specs æ¸²æŸ“ä¸€ä¸ªâ€œä¼ªè§„æ ¼åˆ—è¡¨â€
        if (skuListEl && skuItemsEl && simpleSpecs.length > 0) {
          skuListEl.hidden = false;
          const fmt = window.formatPrice || function(n) { return 'Â¥' + Number(n).toFixed(1); };
          // è§„æ ¼ç»„æ€»æ ‡é¢˜åŒºåŸŸä¸å†å•ç‹¬æ˜¾ç¤ºå…·ä½“ç»„åï¼Œç»„ååœ¨æ¯ä¸€è¡Œå·¦ä¾§å±•ç¤ºï¼ˆé¢œè‰² / æ€»é‡ç­‰ï¼‰
          const groupLabelEl = document.getElementById('skuGroupName');
          if (groupLabelEl) {
            groupLabelEl.textContent = '';
          }
          const groupsHtml = [];
          simpleSpecs.forEach((g, gi) => {
            const groupName = g && g.name ? String(g.name) : '';
            const valueButtons = [];
            (g.values || []).forEach((v, vi) => {
              const valueText = v && v.value ? String(v.value) : '';
              const imgUrl = v && v.img ? String(v.img) : '';
              const name = valueText || 'è§„æ ¼';
              const subText = groupName || 'å¯é€‰è§„æ ¼';
              valueButtons.push(`
                <button class="sku-item sku-item--simple" type="button"
                  data-spec-group-index="${gi}"
                  data-spec-value-index="${vi}"
                  data-spec-group-name="${escapeHtml(groupName)}"
                  data-spec-value-name="${escapeHtml(name)}"
                  data-spec-img="${escapeHtml(imgUrl)}">
                  <span class="sku-item__left">
                    ${imgUrl ? `
                      <span class="sku-item__thumb">
                        <img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(name)}" />
                      </span>
                    ` : ''}
                    <span class="sku-item__texts">
                      <span class="sku-item__name">${escapeHtml(name)}</span>
                      <span class="sku-item__sub">${escapeHtml(subText)}</span>
                    </span>
                  </span>
                </button>
              `);
            });
            // æ¯ä¸ªè§„æ ¼ç»„ä¸€è¡Œï¼šå·¦ä¾§æ˜¯â€œé¢œè‰²/æ€»é‡â€ï¼Œå³ä¾§æ˜¯è¯¥ç»„ä¸‹æ‰€æœ‰é€‰é¡¹
            if (valueButtons.length) {
              groupsHtml.push(`
                <div class="sku-group">
                  <div class="sku-group__label">${escapeHtml(groupName || 'è§„æ ¼')}</div>
                  <div class="sku-group__body">
                    ${valueButtons.join('')}
                  </div>
                </div>
              `);
            }
          });
          skuItemsEl.innerHTML = groupsHtml.join('');

          const mainImgEl = document.getElementById('productMainImg');
          const fmtPrice = window.formatPrice || function(n) { return 'Â¥' + Number(n).toFixed(1); };
          const priceEl = document.querySelector('.product-price');

          // åªåœ¨åŒä¸€è§„æ ¼ç»„å†…é«˜äº®å½“å‰é€‰ä¸­çš„ä¸€é¡¹
          function highlightSimpleRow(btn) {
            if (!btn) return;
            const groupIndex = btn.getAttribute('data-spec-group-index');
            if (!groupIndex) return;
            skuItemsEl
              .querySelectorAll(`.sku-item[data-spec-group-index="${groupIndex}"]`)
              .forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
          }

          // å°è¯•æŸ¥æ‰¾åŒ¹é…çš„ SKU æ•°æ®
          function findMatchingSku() {
            if (!skus || skus.length === 0) return null;
            // æ”¶é›†å½“å‰é€‰ä¸­çš„è§„æ ¼å€¼
            const currentselections = [];
            skuItemsEl.querySelectorAll('.sku-item.active').forEach(btn => {
               currentselections.push({
                 group: btn.getAttribute('data-spec-group-name'),
                 value: btn.getAttribute('data-spec-value-name')
               });
            });
            
            // åœ¨ skus ä¸­æŸ¥æ‰¾å®Œå…¨åŒ¹é…çš„é¡¹
            return skus.find(sku => {
               if (!sku.values || sku.values.length === 0) return false;
               // æ£€æŸ¥æ¯ä¸€ä¸ªé€‰ä¸­é¡¹æ˜¯å¦åœ¨ sku.values ä¸­å­˜åœ¨
               // åŒæ—¶ä¹Ÿåº”æ£€æŸ¥ sku.values æ˜¯å¦éƒ½åœ¨é€‰ä¸­é¡¹ä¸­ï¼ˆä¸¥æ ¼åŒ¹é…ï¼‰ï¼Œæˆ–è€…è‡³å°‘åŒ…å«æ‰€æœ‰é€‰ä¸­é¡¹
               // è€ƒè™‘åˆ°å¯èƒ½åªé€‰äº†éƒ¨åˆ†ï¼Œæˆ‘ä»¬åšâ€œæœ€ä½³åŒ¹é…â€ï¼šæ‰€æœ‰é€‰ä¸­çš„éƒ½å¿…é¡»ç¬¦åˆ
               return currentselections.every(sel => {
                 return sku.values.some(v => v.groupName === sel.group && v.value === sel.value);
               });
            });
          }

          skuItemsEl.querySelectorAll('.sku-item').forEach((btn) => {
            btn.addEventListener('click', () => {
              highlightSimpleRow(btn);
              
              // 1. ä¼˜å…ˆå°è¯•ä» SKU ç»„åˆä¸­æ‰¾å›¾
              let targetImg = '';
              let targetPrice = null;
              
              const matchedSku = findMatchingSku();
              if (matchedSku) {
                if (matchedSku.img) targetImg = matchedSku.img;
                if (matchedSku.price != null) targetPrice = matchedSku.price;
              }
              
              // 2. å¦‚æœæ²¡æœ‰ SKU å›¾ï¼Œå›é€€åˆ°è§„æ ¼å€¼è‡ªå¸¦å›¾
              if (!targetImg) {
                 targetImg = btn.getAttribute('data-spec-img') || '';
              }

              if (targetImg && mainImgEl) {
                mainImgEl.src = targetImg;
              }
              if (targetPrice != null && priceEl) {
                priceEl.textContent = fmtPrice(targetPrice);
              } else if (priceEl) {
                priceEl.textContent = fmtPrice(p.price ?? 0);
              }
            });
          });

          // é»˜è®¤æ¯ä¸ªè§„æ ¼ç»„é«˜äº®ç¬¬ä¸€é¡¹ï¼Œä¿è¯æ‰€æœ‰è§„æ ¼éƒ½æœ‰ä¸€ä¸ªé»˜è®¤é€‰æ‹©
          const firstPerGroup = {};
          skuItemsEl.querySelectorAll('.sku-item').forEach((btn) => {
            const gi = btn.getAttribute('data-spec-group-index');
            if (gi != null && !(gi in firstPerGroup)) {
              firstPerGroup[gi] = btn;
            }
          });
          Object.values(firstPerGroup).forEach((btn) => {
            highlightSimpleRow(btn);
          });
          
          // åˆå§‹åŠ è½½æ—¶ä¹Ÿå°è¯•ä¸€æ¬¡åŒ¹é…ï¼ˆæ›´æ–°ä»·æ ¼/å›¾ç‰‡ï¼‰
          setTimeout(() => {
             const matchedSku = findMatchingSku();
             if (matchedSku) {
               if (matchedSku.img && mainImgEl) mainImgEl.src = matchedSku.img;
               if (matchedSku.price != null && priceEl) priceEl.textContent = fmtPrice(matchedSku.price);
             }
          }, 0);

          // ä½¿ç”¨ç®€å•è§„æ ¼æ—¶ï¼Œåé¢çš„ sku é€»è¾‘ç›´æ¥è·³è¿‡
          return;
        }

        // å½“å‰é€‰ä¸­çš„ skuï¼ˆç”±åˆ—è¡¨æ§åˆ¶ï¼‰
        let selectedSku = skus && skus.length ? skus[0] : null;

        // æ„å»º valueId -> æ–‡æœ¬ æ˜ å°„ï¼Œç”¨äºæ‹¼æ¥ SKU åç§°
        const valueTextMap = {};
        attributes.forEach((g) => {
          (g.values || []).forEach((v) => {
            valueTextMap[String(v.id)] = v.value || '';
          });
        });

        function skuDisplayName(sku) {
          const ids = (sku.values || []).map((v) => String(v.valueId)).filter(Boolean);
          const parts = ids.map((id) => valueTextMap[id]).filter(Boolean);
          return parts.length ? parts.join(' / ') : (sku.skuName || 'æ ‡å‡†è§„æ ¼');
        }

        function highlightSkuRow(skuId) {
          if (!skuItemsEl) return;
          skuItemsEl.querySelectorAll('.sku-item').forEach((btn) => {
            btn.classList.toggle('active', String(btn.dataset.skuId) === String(skuId));
          });
        }

        if (skuListEl && skuItemsEl && skus.length > 0) {
          skuListEl.hidden = false;
          const fmt = window.formatPrice || function(n) { return 'Â¥' + Number(n).toFixed(1); };
          skuItemsEl.innerHTML = skus.map((s, idx) => {
            const name = skuDisplayName(s);
            const priceText = fmt(s.price ?? p.price ?? 0);
            const sub = (s.stock != null) ? `åº“å­˜ ${s.stock}` : (s.sales != null ? `é”€é‡ ${s.sales}` : 'å¯é€‰è§„æ ¼');
            return `
              <button class="sku-item${idx === 0 ? ' active' : ''}" type="button" data-sku-id="${escapeHtml(String(s.id || idx))}">
                <span class="sku-item__left">
                  <span class="sku-item__name">${escapeHtml(name)}</span>
                  <span class="sku-item__sub">${escapeHtml(sub)}</span>
                </span>
                <span class="sku-item__right">${escapeHtml(priceText)}</span>
              </button>
            `;
          }).join('');

          // ç‚¹å‡»è§„æ ¼è¡Œï¼šåŒæ­¥ option pills + ä»·æ ¼/ä¸»å›¾
          skuItemsEl.querySelectorAll('.sku-item').forEach((btn, idx) => {
            btn.addEventListener('click', () => {
              const sku = skus[idx];
              if (!sku) return;
              selectedSku = sku;
              highlightSkuRow(btn.dataset.skuId);
              // è§¦å‘ UI æ›´æ–°
              applySkuToUI();
            });
          });
        } else if (skuListEl) {
          skuListEl.hidden = true;
        }

        function applySkuToUI() {
          const priceEl = document.querySelector('.product-price');
          const imgEl = document.getElementById('productMainImg');
          if (!priceEl) return;
          const fmt = window.formatPrice || function(n) { return 'Â¥' + Number(n).toFixed(1); };
          if (selectedSku) {
            priceEl.textContent = fmt(selectedSku.price ?? 0);
            // SKU å›¾ç‰‡ä»…åˆ‡æ¢ä¸»å›¾ï¼Œä¸é‡å»ºç¼©ç•¥å›¾åˆ—è¡¨
            if (imgEl && selectedSku.img) {
              imgEl.src = selectedSku.img;
              const thumbsEl = document.getElementById('productThumbs');
              if (thumbsEl) {
                thumbsEl.querySelectorAll('.product-thumb').forEach((b) => b.classList.remove('active'));
              }
            }
            // åŒæ­¥é«˜äº®è§„æ ¼åˆ—è¡¨
            if (selectedSku.id != null) {
              highlightSkuRow(selectedSku.id);
            }
          } else {
            // æ²¡åŒ¹é…åˆ°ï¼šå›é€€åŸºç¡€ä»·/ä¸»å›¾
            priceEl.textContent = fmt(p.price ?? 0);
            if (imgEl && p.img) imgEl.src = p.img;
          }
        }

        applySkuToUI();
        // é»˜è®¤é«˜äº®ç¬¬ä¸€æ¡ sku
        if (skus.length > 0) {
          highlightSkuRow(skus[0].id ?? 0);
        }
      }

      function loadProductDetail() {
        const hasBackend = typeof BACKEND_BASE_URL !== 'undefined';
        if (hasBackend) {
          fetch(`${BACKEND_BASE_URL}/api/products/${encodeURIComponent(productId)}`)
            .then(res => res.json())
            .then(data => {
              if (data && data.ok && data.item) {
                applyProductToPage(data.item);
              } else {
                loadProductFromLocal();
              }
            })
            .catch(() => {
              loadProductFromLocal();
            });
        } else {
          loadProductFromLocal();
        }
      }

      function loadProductFromLocal() {
        const source = (window.productsFromServer && window.productsFromServer.length)
          ? window.productsFromServer
          : (window.PRODUCTS || []);
        const p = source.find(item => item.id === productId);
        applyProductToPage(p);
      }

      // åˆå§‹åŒ–è§„æ ¼ä¸è¯¦æƒ…
      loadProductDetail();
    </script>
  </body>
</html>